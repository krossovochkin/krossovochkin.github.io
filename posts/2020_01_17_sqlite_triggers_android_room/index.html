<!DOCTYPE html>
<html lang="en-us">
<head>
  <title>SQLite Triggers (&#43; Android Room)</title>

  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="apple-touch-icon-144-precompressed.png"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <script src="https://kit.fontawesome.com/6d5aec2882.js" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="/css/style.css" />

  <link rel="me" href="https://androiddev.social/@krossovochkin" />

  
  <meta name="theme-color" content="#1e2327">

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SQLite Triggers (&#43; Android Room)"/>
<meta name="twitter:description" content="Introduction SQLite is one of the most used database. This is because it is used on almost all mobile devices in the world. As SQLite is very similar to SQL everyone already knows the basic concepts like querying, inserting, updating, deleting data; databases and tables; joining tables etc. But SQLite also has some advanced features and this article is about one of such called Trigger.
If we try to speculate on the name “Trigger” we might say that probably something will be done when some changes are made to the database."/>
<meta name="twitter:site" content="@krossovochkin"/>

</head>

<body>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-148934073-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


<header>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/about">About</a></li>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    <li class="menu-left"><a href="/apps">Apps</a></li>
    
    
    <li class="menu-right"><a rel="me" href="https://t.me/krossovochkin_newsletter" target="_blank"><i class="fa-brands fa-telegram fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://stackoverflow.com/users/1533933/krossovochkin" target="_blank"><i class="fa-brands fa-stack-overflow fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://linkedin.com/in/vasyadrobushkov" target="_blank"><i class="fa-brands fa-linkedin fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://facebook.com/vasya.drobushkov" target="_blank"><i class="fa-brands fa-facebook fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="/index.xml" target="_blank"><i class="fa-solid fa-rss fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://androiddev.social/@krossovochkin" target="_blank"><i class="fa-brands fa-mastodon fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://github.com/krossovochkin" target="_blank"><i class="fa-brands fa-github fa-l"></i></a></li>
    
  </ul>
</nav>

</header>

<br/>


<div class="meta">

  
    <h1><span class="title">SQLite Triggers (+ Android Room)</span></h1>
  
  
    <h3>January 17, 2020</h3>
  

</div>

<main>
<p><a href="https://proandroiddev.com/sqlite-triggers-android-room-2e7120bb3e3a"><img src="https://img.shields.io/badge/original-proandroiddev-green#badge" alt=""></a> <a href="https://androidweekly.net/issues/issue-397"><img src="https://img.shields.io/badge/androidweekly-397-blue#badge" alt=""></a></p>
<h2 id="introduction">Introduction</h2>
<p>SQLite is one of the <a href="https://www.sqlite.org/mostdeployed.html">most used</a> database. This is because it is used on almost all mobile devices in the world. As SQLite is very similar to SQL everyone already knows the basic concepts like querying, inserting, updating, deleting data; databases and tables; joining tables etc.
But SQLite also has some advanced features and this article is about one of such called Trigger.</p>
<p>If we try to speculate on the name “Trigger” we might say that probably something will be done when some changes are made to the database. And we’re pretty close to the truth.</p>
<p>According to <a href="https://www.sqlite.org/lang_createtrigger.html">documentation</a>:</p>
<blockquote>
<p>Triggers are database operations that are automatically performed when a specified database event occurs.</p>
</blockquote>
<p>Pretty clear, but there is one caveat: this change doesn’t leave SQLite world. That “operation” is not any kind of callback that we can handle and do some work. No, instead we can intercept some SQLite query and either do some work <em>before</em> it, <em>instead of</em> it or *after *it.</p>
<p>Syntax of how to create trigger will help us to understand what we’re able to do:</p>
<p><img src="../../img/0_brVEPrRO0JZpLmhY.gif" alt="Source"><em><a href="https://www.sqlite.org/lang_createtrigger.html">Source</a></em></p>
<p>Let’s analyze this line by line:</p>
<ul>
<li>
<p>CREATE TRIGGER — command that says that we want to create trigger.</p>
</li>
<li>
<p>trigger-name — is a name of the trigger</p>
</li>
<li>
<p>BEFORE/AFTER/INSTEAD OF — is a mode of the trigger (when we’d like our operation to work — before our actual query, after or instead)</p>
</li>
<li>
<p>DELETE/INSERT/UPDATE ON table-name — is description on the query which will activate our trigger</p>
</li>
<li>
<p>BEGIN stmt; END — is actual trigger operation</p>
</li>
</ul>
<blockquote>
<p>For other parts of create trigger statement please take a look at <a href="https://www.sqlite.org/lang_createtrigger.html">documentation</a></p>
</blockquote>
<p>So, if we’d like to create trigger, we can execute such query:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">CREATE</span><span class="w"> </span><span class="k">TRIGGER</span><span class="w"> </span><span class="n">update_value</span><span class="w"> </span><span class="k">INSTEAD</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">persons</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">BEGIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">persons</span><span class="p">(</span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">END</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>In such example whenever any update on persons table happen instead of actual update for all affected rows, value of column age will be set to 21.</p>
<p>This example looks weird, but main idea is to become familiar with syntax. And now, when we should be fine with that, one important question might arise: why we need or even might need triggers?
It feels so unsafe to implement business logic this way as it will be difficult to test, it might be broken with database schema updates and it is implicit somewhere inside SQL. It seems better to expose all the callbacks of database changes to our actual program and implement all the required logic in code.
And personally I think that this is for sure relevant questions.</p>
<p>However one of the cases where triggers might be not bad is logging over table changes. Let’s see how it might look like with example.</p>
<h2 id="sqlite-trigger-example">SQLite Trigger Example</h2>
<p>Let’s imagine that we have some data which can be structured in one table (we’ll call it data) with such structure:</p>
<pre tabindex="0"><code>order_id | timestamp | price
</code></pre><p>Table contains three columns:</p>
<ul>
<li>
<p>order_id — some id of order</p>
</li>
<li>
<p>timestamp — timestamp when order should be executed</p>
</li>
<li>
<p>price — price of the order</p>
</li>
</ul>
<p>And for example we’d like to be able to log all the information on when and what was inserted into that database.
We’ll store that information in the log table. It has the following structure:</p>
<pre tabindex="0"><code>_id | timestamp | payload
</code></pre><p>Where:</p>
<ul>
<li>
<p>_id — is generic id</p>
</li>
<li>
<p>timestamp — is timestamp of when insertion was done</p>
</li>
<li>
<p>payload — is data which was inserted</p>
</li>
</ul>
<p>Let’s solve this problem using triggers.</p>
<h3 id="setup">Setup</h3>
<p>First of all we’ll download SQLite command line tool for our platform following instructions <a href="https://www.sqlite.org/download.html">here</a>.
Then we run sqlite3 in terminal providing database name and we’re ready:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">% sqlite testdb
</span></span></code></pre></div><h3 id="create-tables">Create tables</h3>
<p>Then let’s create our tables:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sqlite &gt; create table data<span class="o">(</span>order_id integer primary key, timestamp integer, price real<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">sqlite &gt; create table log<span class="o">(</span>_id integer primary key, timestamp text, payload text<span class="o">)</span><span class="p">;</span> 
</span></span></code></pre></div><blockquote>
<p>If you stuck with syntax you always can check <a href="https://sqlite.org/cli.html">documentation </a>on command-line-interface of SQLite</p>
</blockquote>
<h3 id="create-trigger">Create trigger</h3>
<p>Now let’s create trigger:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">create trigger order_added after insert on data
</span></span><span class="line"><span class="cl">begin
</span></span><span class="line"><span class="cl">insert into log<span class="o">(</span>timestamp, payload<span class="o">)</span> values<span class="o">(</span>datetime<span class="o">()</span>, new.order_id <span class="o">||</span> <span class="s1">&#39; &#39;</span> <span class="o">||</span> new.timestamp <span class="o">||</span> <span class="s1">&#39; &#39;</span> <span class="o">||</span> new.price<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">end<span class="p">;</span>
</span></span></code></pre></div><p>Here we:</p>
<ul>
<li>
<p>create trigger called order_added (because we want to trigger on order added into data table)</p>
</li>
<li>
<p>that trigger should activate after insert on data — after something is inserted into data table</p>
</li>
<li>
<p>actual operation inserts into log table current time and concatenated values of what was inserted into data table</p>
</li>
</ul>
<blockquote>
<p>One can see that data which activated our trigger’s operation can be accessed via new. . So if we’d like to access price which was inserted into data table we can refer to it as new.price</p>
</blockquote>
<h3 id="activate-trigger">Activate trigger</h3>
<p>So now we’re ready to activate our trigger by inserting something into data table:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sqlite &gt; insert into data<span class="o">(</span>timestamp, price<span class="o">)</span> values<span class="o">(</span>1568069843, 12.2<span class="o">)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">sqlite &gt; insert into data<span class="o">(</span>timestamp, price<span class="o">)</span> values<span class="o">(</span>1568069862, 15.2<span class="o">)</span><span class="p">;</span>
</span></span></code></pre></div><h3 id="check-result">Check result</h3>
<p>To check the result let’s query what is inside log table:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">sqlite &gt; <span class="k">select</span> * from log<span class="p">;</span>
</span></span><span class="line"><span class="cl">1<span class="p">|</span>2020-01-03 06:46:52<span class="p">|</span><span class="m">1</span> <span class="m">1568069843</span> 12.2
</span></span><span class="line"><span class="cl">2<span class="p">|</span>2020-01-03 06:46:56<span class="p">|</span><span class="m">2</span> <span class="m">1568069862</span> 15.2
</span></span></code></pre></div><p>And we see that we have exactly two records in our log table. Timestamp column has date-time of when data was inserted and payload column has all the information on the data that was inserted.</p>
<p>OK, that was interesting. That doesn’t mean that tomorrow you should start using triggers, but at least it is good to know that such feature exists.
Though we here used command line tool, but maybe we’d like to create trigger inside our Android app. Let’s look how we can achieve that.</p>
<h2 id="android-room-add-sqlite-trigger">Android Room add SQLite Trigger</h2>
<p>Using SQLite database on Android is traditionally was done using SQLiteDatabase, SQLiteOpenHelper and Cursor.
Though now Room from architecture components becomes one of the most common ways to work with database on Android. But Room doesn’t support triggers (whereas SQLiteDatabase does).
Therefore in order to work with triggers on Android we have to return to the basics.</p>
<p>In Room during database creation we can add callback where we can get access to the SQLiteDatabase. On that database we can call execSQL method, which is basically executing SQL command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">db</span><span class="p">.</span><span class="n">execSQL</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s">    create trigger order_added after insert on data
</span></span></span><span class="line"><span class="cl"><span class="s">    begin
</span></span></span><span class="line"><span class="cl"><span class="s">    insert into log(timestamp, payload) values(datetime(), new.order_id || &#39; &#39; || new.timestamp || &#39; &#39; || new.price);
</span></span></span><span class="line"><span class="cl"><span class="s">    end;
</span></span></span><span class="line"><span class="cl"><span class="s">    &#34;&#34;&#34;</span><span class="p">.</span><span class="n">trimIndent</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>And that’s it.</p>
<blockquote>
<p>It is worth noting that (considering that triggers can be abused and lead to some issues if handled without care) SQLite command written in execSQL is not validated at compile time (unlike commands one can write in Room’s @Query annotation). So here one should be twice as more attentive.</p>
</blockquote>
<p>But to test that it works let’s add a bit of a code. We’ll start from describing our entities:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Entity</span><span class="p">(</span><span class="n">tableName</span> <span class="p">=</span> <span class="s2">&#34;data&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">data</span> <span class="k">class</span> <span class="nc">Order</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@PrimaryKey</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ColumnInfo</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s2">&#34;order_id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">orderId</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@ColumnInfo</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">timestamp</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@ColumnInfo</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s2">&#34;price&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">price</span><span class="p">:</span> <span class="n">Double</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Entity</span><span class="p">(</span><span class="n">tableName</span> <span class="p">=</span> <span class="s2">&#34;log&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">data</span> <span class="k">class</span> <span class="nc">OrderInsertedLog</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@PrimaryKey</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ColumnInfo</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s2">&#34;_id&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">id</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@ColumnInfo</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s2">&#34;timestamp&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">timestamp</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@ColumnInfo</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s2">&#34;payload&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">payload</span><span class="p">:</span> <span class="n">String</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>Next create DAOs:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Dao</span>
</span></span><span class="line"><span class="cl"><span class="k">interface</span> <span class="nc">OrderDao</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Insert</span>
</span></span><span class="line"><span class="cl">    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">insert</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Query</span><span class="p">(</span><span class="s2">&#34;select * from data&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">read</span><span class="p">():</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Dao</span>
</span></span><span class="line"><span class="cl"><span class="k">interface</span> <span class="nc">LogDao</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Query</span><span class="p">(</span><span class="s2">&#34;select * from log&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">read</span><span class="p">():</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">OrderInsertedLog</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And finally we’ll create a database we’ll work with:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Database</span><span class="p">(</span><span class="n">entities</span> <span class="p">=</span> <span class="p">[</span><span class="n">Order</span><span class="o">::</span><span class="k">class</span><span class="p">,</span> <span class="n">OrderInsertedLog</span><span class="o">::</span><span class="k">class</span><span class="p">],</span> <span class="n">version</span> <span class="p">=</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">abstract</span> <span class="k">class</span> <span class="nc">AppDb</span> <span class="p">:</span> <span class="n">RoomDatabase</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">abstract</span> <span class="k">fun</span> <span class="nf">orderDao</span><span class="p">():</span> <span class="n">OrderDao</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">abstract</span> <span class="k">fun</span> <span class="nf">logDao</span><span class="p">():</span> <span class="n">LogDao</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">private</span> <span class="k">var</span> <span class="py">INSTANCE</span><span class="p">:</span> <span class="n">AppDb</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">fun</span> <span class="nf">getDatabase</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">):</span> <span class="n">AppDb</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">INSTANCE</span> <span class="o">?:</span> <span class="n">Room</span>
</span></span><span class="line"><span class="cl">                <span class="p">.</span><span class="n">databaseBuilder</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">context</span><span class="p">.</span><span class="n">applicationContext</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">AppDb</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;appdb&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">.</span><span class="n">addCallback</span><span class="p">(</span><span class="n">DB_CALLBACK</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">.</span><span class="n">build</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="p">.</span><span class="n">also</span> <span class="p">{</span> <span class="n">INSTANCE</span> <span class="p">=</span> <span class="k">it</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">        <span class="k">private</span> <span class="k">val</span> <span class="py">DB</span><span class="n">_CALLBACK</span> <span class="p">=</span> <span class="k">object</span> <span class="err">: </span><span class="nc">RoomDatabase</span><span class="p">.</span><span class="n">Callback</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">db</span><span class="p">:</span> <span class="n">SupportSQLiteDatabase</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">db</span><span class="p">.</span><span class="n">execSQL</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>If you have issues with setting up Room you can refer to the <a href="https://developer.android.com/training/data-storage/room">documentation</a></p>
</blockquote>
<p>And in ViewModel we’ll actually use this database to verify that our trigger worked:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span><span class="p">.</span><span class="n">orderDao</span><span class="p">().*</span><span class="n">apply</span> <span class="p">*{</span>
</span></span><span class="line"><span class="cl">        <span class="n">insert</span><span class="p">(</span><span class="n">Order</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1568069843</span><span class="p">,</span> <span class="m">12.2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">insert</span><span class="p">(</span><span class="n">Order</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">1568069862</span><span class="p">,</span> <span class="m">15.2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">db</span><span class="p">.</span><span class="n">logDao</span><span class="p">().</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.*</span><span class="n">forEach</span> <span class="p">*{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Log</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="s2">&#34;TEST_DB&#34;</span><span class="p">,</span> <span class="s2">&#34;log: </span><span class="si">$it</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The results printed in logs will be:</p>
<pre tabindex="0"><code>E/TEST_DB: log: OrderInsertedLog(id=1, timestamp=2020-01-03 08:20:01, payload=1 1568069843 12.2)
E/TEST_DB: log: OrderInsertedLog(id=2, timestamp=2020-01-03 08:20:01, payload=2 1568069862 15.2)
</code></pre><p>And that means that our trigger worked great!</p>
<h2 id="android-room-changes-callback">Android Room Changes callback</h2>
<p>Having SQLite triggers might be fun, but in usual work we are most interested in the handling some changes in our queries inside our code. This might be some callback, RxJava Observable, Kotlin coroutines Flow etc (which triggers on some update). Let’s find out how it works.</p>
<p>First or all we’ll change the DAO for our log table to return instead of list of items in the table — Flow of these lists to get actual values when they appear in table:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Dao</span>
</span></span><span class="line"><span class="cl"><span class="k">interface</span> <span class="nc">LogDao</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Query</span><span class="p">(</span><span class="s2">&#34;select * from log&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">read</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">OrderInsertedLog</span><span class="p">&gt;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And we replace usage of our LogDao to instead collect data from Flow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">db</span><span class="p">.</span><span class="n">logDao</span><span class="p">().</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="k">data</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="k">data</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">Log</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="s2">&#34;TEST_DB&#34;</span><span class="p">,</span> <span class="s2">&#34;log: </span><span class="si">$it</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><p>After we execute the program, we’ll see that nothing will be changed so far. First, our program inserts values into data table, then our trigger writes into log, after that we start the Flow from log table and receive new values.</p>
<p>Let’s look at how inside all this is implemented.
When we look at the implementation of the LogDao#read we see that it uses CoroutinesRoom.createFlow method (<a href="https://android.googlesource.com/platform/frameworks/support/+/refs/heads/androidx-master-dev/room/ktx/src/main/java/androidx/room/CoroutinesRoom.kt">source code</a>).
Here is short snippet of how this method looks like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@JvmStatic</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="p">&lt;</span><span class="nc">R</span><span class="p">&gt;</span> <span class="nf">createFlow</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span><span class="p">:</span> <span class="n">RoomDatabase</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">inTransaction</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">tableNames</span><span class="p">:</span> <span class="n">Array</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;,</span>
</span></span><span class="line"><span class="cl">    <span class="n">callable</span><span class="p">:</span> <span class="n">Callable</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="nd">@JvmSuppressWildcards</span><span class="p">)</span> <span class="n">R</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">observerChannel</span> <span class="p">=</span> <span class="n">Channel</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;(</span><span class="n">Channel</span><span class="p">.</span><span class="n">CONFLATED</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">observer</span> <span class="p">=</span> <span class="k">object</span> <span class="err">: </span><span class="nc">InvalidationTracker</span><span class="p">.</span><span class="n">Observer</span><span class="p">(</span><span class="n">tableNames</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">override</span> <span class="k">fun</span> <span class="nf">onInvalidated</span><span class="p">(</span><span class="n">tables</span><span class="p">:</span> <span class="n">MutableSet</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">observerChannel</span><span class="p">.</span><span class="n">offer</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">observerChannel</span><span class="p">.</span><span class="n">offer</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="c1">// Initial signal to perform first query.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="n">db</span><span class="p">.</span><span class="n">invalidationTracker</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">signal</span> <span class="k">in</span> <span class="n">observerChannel</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">callable</span><span class="p">.</span><span class="n">call</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>So what important this function does:</p>
<ul>
<li>
<p>it creates InvalidationTracker.Observer</p>
</li>
<li>
<p>registers it in db.invalidationTracker</p>
</li>
<li>
<p>each update from db.invalidationTracker will lead to executing callable, in which actual request to table is made to get results which should be returned to the caller</p>
</li>
</ul>
<p>Should be good to understand that database has some invalidationTracker which can signal when some table was invalidated.</p>
<blockquote>
<p>NOTE: one can see that InvalidattionTracker.Observer is created for some particular tables. When these tables are changed — observer will be triggered.</p>
</blockquote>
<p>If we go to InvalidationTracker <a href="https://android.googlesource.com/platform/frameworks/support/+/refs/heads/androidx-master-dev/room/runtime/src/main/java/androidx/room/InvalidationTracker.java">sources </a>we’ll see that it is actually not that small class. Here I’ll highlight main things for understanding what it is and how it works.</p>
<p>First thing is that tracker creates its own utility temp table in database for writing there all the changes made in tables:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">CREATE_TRACKING_TABLE_SQL</span> <span class="o">=</span> 
</span></span><span class="line"><span class="cl">    <span class="s">&#34;CREATE TEMP TABLE &#34;</span> <span class="o">+</span> <span class="n">UPDATE_TABLE_NAME</span> <span class="o">+</span> <span class="s">&#34;(&#34;</span> 
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="n">TABLE_ID_COLUMN_NAME</span> <span class="o">+</span> <span class="s">&#34; INTEGER PRIMARY KEY, &#34;</span> 
</span></span><span class="line"><span class="cl">    <span class="o">+</span> <span class="n">INVALIDATED_COLUMN_NAME</span> <span class="o">+</span> <span class="s">&#34; INTEGER NOT NULL DEFAULT 0)&#34;</span><span class="o">;</span>
</span></span></code></pre></div><p>Then there is a method to start tracking some table in database for changes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">startTrackingTable</span><span class="o">(</span><span class="n">SupportSQLiteDatabase</span> <span class="n">writableDb</span><span class="o">,</span> <span class="kt">int</span> <span class="n">tableId</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">writableDb</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;INSERT OR IGNORE INTO &#34;</span> <span class="o">+</span> <span class="n">UPDATE_TABLE_NAME</span> <span class="o">+</span> <span class="s">&#34; VALUES(&#34;</span> <span class="o">+</span> <span class="n">tableId</span> <span class="o">+</span> <span class="s">&#34;, 0)&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">String</span> <span class="n">tableName</span> <span class="o">=</span> <span class="n">mTableNames</span><span class="o">[</span><span class="n">tableId</span><span class="o">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">StringBuilder</span> <span class="n">stringBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">trigger</span> <span class="o">:</span> <span class="n">TRIGGERS</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">stringBuilder</span><span class="o">.</span><span class="na">setLength</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">stringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;CREATE TEMP TRIGGER IF NOT EXISTS &#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">appendTriggerName</span><span class="o">(</span><span class="n">stringBuilder</span><span class="o">,</span> <span class="n">tableName</span><span class="o">,</span> <span class="n">trigger</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">stringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34; AFTER &#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">trigger</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34; ON `&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">tableName</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;` BEGIN UPDATE &#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">UPDATE_TABLE_NAME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34; SET &#34;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">INVALIDATED_COLUMN_NAME</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&#34; = 1&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34; WHERE &#34;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">TABLE_ID_COLUMN_NAME</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&#34; = &#34;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">tableId</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34; AND &#34;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">INVALIDATED_COLUMN_NAME</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&#34; = 0&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;; END&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">writableDb</span><span class="o">.</span><span class="na">execSQL</span><span class="o">(</span><span class="n">stringBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>And whoa! Tracker creates trigger for any update, insert or delete for a given table with copying table name and column to the tracking table. Sounds familiar!</p>
<p>This method is called in:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">syncTriggers</span><span class="o">(</span><span class="n">SupportSQLiteDatabase</span> <span class="n">database</span><span class="o">)</span>
</span></span></code></pre></div><p>This method in short checks all the registered observers and based on that either creates triggers or removes them.</p>
<p>Also tracker has:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Runnable</span> <span class="n">mRefreshRunnable</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">   <span class="o">...</span>
</span></span><span class="line"><span class="cl">     <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mObserverMap</span><span class="o">)</span> <span class="o">{</span>                    
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">entry</span> <span class="o">:</span> <span class="n">mObserverMap</span><span class="o">)</span> <span class="o">{</span>               
</span></span><span class="line"><span class="cl">            <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">notifyByTableInvalidStatus</span><span class="o">(</span><span class="n">invalidatedTableIds</span><span class="o">);</span>  
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>In which actual checks on what was updated are made and where all the registered observers are notified.</p>
<blockquote>
<p>Cases in which all these methods (such as syncTriggers, or running refresh runnable) called are out of scope of this article. It is better to check the source code directly</p>
</blockquote>
<h2 id="android-room-changes-callback-and-custom-sqlite-trigger">Android Room Changes callback and custom SQLite Trigger</h2>
<p>Now as we know how under the hood updates are triggered into our code, let’s try to test on how this is related to the custom SQLite triggers.
The case we’re interested in is whether custom SQLite trigger’s operation can trigger our code which is listening for changes in the place SQLite trigger’s operation is changing.</p>
<p>Now we can make an educated guess that as we’ve created SQLite trigger and Room under the hood also uses SQLite triggers — everything should work well.</p>
<p>For our test the only thing that we’ll change comparing to the previous test is order in which we subscribe for changes to log table and insert into data table.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">db</span><span class="p">.</span><span class="n">logDao</span><span class="p">().</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.*</span><span class="n">onEach</span> <span class="p">*{</span> <span class="k">data</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="k">data</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Log</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="s2">&#34;TEST_DB&#34;</span><span class="p">,</span> <span class="s2">&#34;log empty&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">data</span><span class="p">.*</span><span class="n">forEach</span> <span class="p">*{</span>
</span></span><span class="line"><span class="cl">                <span class="n">Log</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="s2">&#34;TEST_DB&#34;</span><span class="p">,</span> <span class="s2">&#34;log: </span><span class="si">$it</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">launchIn</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">db</span><span class="p">.</span><span class="n">orderDao</span><span class="p">().*</span><span class="n">apply</span> <span class="p">*{</span>
</span></span><span class="line"><span class="cl">        <span class="n">insert</span><span class="p">(</span><span class="n">Order</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1568069843</span><span class="p">,</span> <span class="m">12.2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">insert</span><span class="p">(</span><span class="n">Order</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">1568069862</span><span class="p">,</span> <span class="m">15.2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>What we’d expect after code execution?
Probably that we’ll get three emits in log flow:</p>
<ul>
<li>
<p>empty list (initial state)</p>
</li>
<li>
<p>list with first order</p>
</li>
<li>
<p>list with two (first and second) orders</p>
</li>
</ul>
<p>In reality we’ll see the following:</p>
<pre tabindex="0"><code>E/TEST_DB: log empty
E/TEST_DB: log: OrderInsertedLog(id=1, timestamp=2020-01-03 08:53:12, payload=1 1568069843 12.2)E/TEST_DB: log: OrderInsertedLog(id=2, timestamp=2020-01-03 08:53:12, payload=2 1568069862 15.2)
</code></pre><p>We’ve got only two emits (empty list and list with two orders).
The reason behind that is that our code runs concurrently, our inserts are pretty close and implementation makes its best to deliver results.</p>
<p>Though the main thing here is that flow from Room works well with custom Triggers. And it is not surprise. There is our custom trigger which listens to data table and writes into log table, and there is Room’s trigger which listens to log table and writes into its internal table (to deliver results into our code). So these dependent calls work pretty well.</p>
<h2 id="conclusion">Conclusion</h2>
<p>And that’s it what I have for you for now. I hope now you know a little bit more on the database change triggers — both SQLite and Room— and now you’ll be able to make some weighted decisions in the future.
Don’t forget to always dive deep and look at what is happening under the hood and learn basics.</p>
<p>Happy coding!</p>

</main>


<hr/>

<footer>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/about">About</a></li>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    <li class="menu-left"><a href="/apps">Apps</a></li>
    
    
    <li class="menu-right"><a rel="me" href="https://t.me/krossovochkin_newsletter" target="_blank"><i class="fa-brands fa-telegram fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://stackoverflow.com/users/1533933/krossovochkin" target="_blank"><i class="fa-brands fa-stack-overflow fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://linkedin.com/in/vasyadrobushkov" target="_blank"><i class="fa-brands fa-linkedin fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://facebook.com/vasya.drobushkov" target="_blank"><i class="fa-brands fa-facebook fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="/index.xml" target="_blank"><i class="fa-solid fa-rss fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://androiddev.social/@krossovochkin" target="_blank"><i class="fa-brands fa-mastodon fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://github.com/krossovochkin" target="_blank"><i class="fa-brands fa-github fa-l"></i></a></li>
    
  </ul>
</nav>

</footer>


</body>

</html>