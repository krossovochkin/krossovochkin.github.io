<!DOCTYPE html>
<html lang="en-us">
<head>
  <title>From RxJava to Kotlin Flow: Throttling</title>

  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="apple-touch-icon-144-precompressed.png"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <script src="https://kit.fontawesome.com/6d5aec2882.js" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="/css/style.css" />

  <link rel="me" href="https://androiddev.social/@krossovochkin" />

  
  <meta name="theme-color" content="#1e2327">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="From RxJava to Kotlin Flow: Throttling">
  <meta name="twitter:description" content="Comparing Throttling operators in RxJava and Kotlin Flow">

</head>

<body>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-YEWQ4T95D5"></script>
      <script>
        var doNotTrack = false;
        if ( true ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-YEWQ4T95D5');
        }
      </script>

<header>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/about">About</a></li>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    <li class="menu-left"><a href="/apps">Apps</a></li>
    
    
    <li class="menu-right"><a rel="me" href="https://t.me/krossovochkin_newsletter" target="_blank"><i class="fa-brands fa-telegram fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://stackoverflow.com/users/1533933/krossovochkin" target="_blank"><i class="fa-brands fa-stack-overflow fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://linkedin.com/in/vasyadrobushkov" target="_blank"><i class="fa-brands fa-linkedin fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://facebook.com/vasya.drobushkov" target="_blank"><i class="fa-brands fa-facebook fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="/index.xml" target="_blank"><i class="fa-solid fa-rss fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://androiddev.social/@krossovochkin" target="_blank"><i class="fa-brands fa-mastodon fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://github.com/krossovochkin" target="_blank"><i class="fa-brands fa-github fa-l"></i></a></li>
    
  </ul>
</nav>

</header>

<br/>


<div class="meta">

  
    <h1><span class="title">From RxJava to Kotlin Flow: Throttling</span></h1>
  
  
    <h3>March 2, 2020</h3>
  

</div>

<main>
<p><img src="https://images.unsplash.com/photo-1538474705339-e87de81450e8?ixlib=rb-1.2.1&amp;auto=format&amp;fit=crop&amp;w=1357&amp;q=80" alt="Source"><em><a href="https://unsplash.com/photos/scUBcasSvbE">Source</a></em></p>
<blockquote>
<p>This post is part of series of comparing RxJava to Kotlin Flow. Previous articles were about <a href="https://proandroiddev.com/from-rxjava-2-to-kotlin-flow-threading-8618867e1955">Threading</a>, <a href="https://proandroiddev.com/from-rxjava-to-kotlin-flow-backpressure-d1fb91e6dea8">Backpressure</a>, <a href="https://proandroiddev.com/from-rxjava-to-kotlin-flow-error-handling-da1f6a4f2708">Error Handling,</a> <a href="https://proandroiddev.com/from-rxjava-to-kotlin-flow-stream-types-7916be6cabc2">Stream Types</a></p>
</blockquote>
<p><a href="https://proandroiddev.com/from-rxjava-to-kotlin-flow-throttling-ed1778847619"><img src="https://img.shields.io/badge/original-proandroiddev-green#badge" alt=""></a> <a href="https://proandroiddev.com/proandroiddev-digest-17-d52bc575edb6"><img src="https://img.shields.io/badge/proandroiddevdigest-17-green#badge" alt=""></a></p>
<p>It is advised to take a look at the overview of Throttling operators in RxJava before reading this article:
<a href="https://proandroiddev.com/throttling-in-rxjava-2-d640ea5f7bf1"><strong>Throttling in RxJava 2</strong></a></p>
<h2 id="introduction">Introduction</h2>
<p>Throttling is also one of the essential features of reactive programming. Streams might emit more values than we’re expecting to receive, so ability to limit number of events in a stream is very important.
Most common place where it applies is handling UI events. Examples of usage might be handling button clicks (to not allow double clicks), usage with search view when we’d like to wait for user to stop typing before querying some data and so on.
In this article we’ll try to compare throttling operators in RxJava and Kotlin Flow.</p>
<h2 id="comparison">Comparison</h2>
<h3 id="setup">Setup</h3>
<p>Before we start as before we’ll start from some setup.
We’ll have stream with many events, which are emitted with delays (after previous) of 90, 90, 1010, 1010, 2000, 90, 1010, 80 milliseconds.
It might be shown as such (scale doesn’t apply):</p>
<p><img src="../../img/1__IwO2_7swxHkAaKBq-Z2NQ.png" alt=""></p>
<p>For RxJava we’ll have the following observable:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">fun</span> <span class="nf">observable</span><span class="p">():</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nc">Observable</span><span class="p">.</span><span class="n">create</span> <span class="p">{</span> <span class="n">emitter</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="n">emitter</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nc">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="m">90</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emitter</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nc">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="m">90</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emitter</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nc">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="m">1010</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emitter</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="m">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nc">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="m">1010</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emitter</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="m">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nc">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="m">2000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emitter</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="m">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nc">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="m">90</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emitter</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="m">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nc">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="m">1010</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emitter</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="m">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nc">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="m">80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emitter</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="m">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emitter</span><span class="p">.</span><span class="n">onComplete</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And for Kotlin Flow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">fun</span> <span class="nf">myFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="m">90</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="m">90</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="m">1010</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="m">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="m">1010</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="m">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="m">2000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="m">6</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="m">90</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="m">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="m">1010</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="m">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="m">80</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="m">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In order to test various throttling strategies we’ll have the following test functions parametrized by operators.</p>
<p>For RxJava:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">fun</span> <span class="nf">testObservable</span><span class="p">(</span><span class="k">operator</span><span class="p">:</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;.()</span> <span class="o">-&gt;</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">latch</span> <span class="p">=</span> <span class="n">CountDownLatch</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">StringBuffer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">observable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="k">operator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">doOnComplete</span> <span class="p">{</span> <span class="n">latch</span><span class="p">.</span><span class="n">countDown</span><span class="p">()</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">subscribeOn</span><span class="p">(</span><span class="n">computation</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">subscribe</span> <span class="p">{</span> <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="k">it</span><span class="p">).</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">latch</span><span class="p">.</span><span class="n">await</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$result</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And for Kotlin Flow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">fun</span> <span class="nf">testFlow</span><span class="p">(</span><span class="k">operator</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;.()</span> <span class="o">-&gt;</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">latch</span> <span class="p">=</span> <span class="n">CountDownLatch</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">StringBuffer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">CoroutineScope</span><span class="p">(</span><span class="n">Job</span><span class="p">()</span> <span class="p">+</span> <span class="nc">Dispatchers</span><span class="p">.</span><span class="n">Default</span><span class="p">).</span><span class="n">launch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">myFlow</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="k">operator</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">onCompletion</span> <span class="p">{</span> <span class="n">latch</span><span class="p">.</span><span class="n">countDown</span><span class="p">()</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="k">it</span><span class="p">).</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34; &#34;</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">latch</span><span class="p">.</span><span class="n">await</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$result</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In all the examples we’ll use timeout of 1000 milliseconds.</p>
<h3 id="debounce">Debounce</h3>
<p>First throttling operator which is useful for search queries (waits until some timeout expired before emitting value) is debounce.
If we show expected result on a plot we’ll see the following:</p>
<p><img src="../../img/1_bPC_0DVfI7FQkSiVmCkHvw.png" alt=""></p>
<p>So, in short after event received we start timer. If new event comes when timer is active, we restart timer. If timer expired then we emit latest item emitted.</p>
<p>So, we expect here to get events from 3, 4, 5, 7 and 9 events (with all other events throttled).</p>
<p>To achieve such result in RxJava we’ll need to use debounce operator:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">testObservable</span> <span class="p">{</span> <span class="n">debounce</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="nc">TimeUnit</span><span class="p">.</span><span class="n">MILLISECONDS</span><span class="p">)</span> <span class="p">}</span>
</span></span></code></pre></div><p>With Kotlin Flow we’ll have to use same operator:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">testFlow</span> <span class="p">{</span> <span class="n">debounce</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span> <span class="p">}</span>
</span></span></code></pre></div><h3 id="throttlelast">ThrottleLast</h3>
<p>This mode starts timer with predefined interval and emit last emitted value when timer expires. After that it will restart timer.</p>
<p><img src="../../img/1_lLXqIZ9_Tysd1V3z3i9hsg.png" alt=""></p>
<p>Here we expect values of 3, 4, 5 and 7 to be emitted.
Value 9 won’t be emitted in this case because stream would be finished before timer expired.</p>
<p>To get such behavior we’ll have to use throttleLast in RxJava and sample in Kotlin Flow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">testObservable</span> <span class="p">{</span> <span class="n">throttleLast</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="nc">TimeUnit</span><span class="p">.</span><span class="n">MILLISECONDS</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">testFlow</span> <span class="p">{</span> <span class="n">sample</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span> <span class="p">}</span>
</span></span></code></pre></div><h3 id="throttlefirst">ThrottleFirst</h3>
<p>This operator is useful to avoid double-clicks on buttons. It emits very first item and starts timer. All items which will come before timer expired will be discarded.</p>
<p><img src="../../img/1_x66TBAX2--F3XtxX54MfJQ.png" alt=""></p>
<p>Here we would expect to receive events 1, 4, 5, 6, 8.</p>
<p>In RxJava we’ll use throttleFirst operator:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">testObservable</span> <span class="p">{</span> <span class="n">throttleFirst</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="nc">TimeUnit</span><span class="p">.</span><span class="n">MILLISECONDS</span><span class="p">)</span> <span class="p">}</span>
</span></span></code></pre></div><p>In Kotlin Flow though there is no such operator, so we’ll have to write some implementation by our own. The implementation might look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="nf">Flow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">throttleFirstJava</span><span class="p">(</span><span class="n">periodMillis</span><span class="p">:</span> <span class="n">Long</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">require</span><span class="p">(</span><span class="n">periodMillis</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&#34;period should be positive&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">var</span> <span class="py">lastTime</span> <span class="p">=</span> <span class="m">0L</span>
</span></span><span class="line"><span class="cl">        <span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="k">val</span> <span class="py">currentTime</span> <span class="p">=</span> <span class="nc">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">currentTime</span> <span class="p">-</span> <span class="n">lastTime</span> <span class="o">&gt;=</span> <span class="n">periodMillis</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">lastTime</span> <span class="p">=</span> <span class="n">currentTime</span>
</span></span><span class="line"><span class="cl">                <span class="n">emit</span><span class="p">(</span><span class="k">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And the usage will be:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">testFlow</span> <span class="p">{</span> <span class="n">throttleFirstJava</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span> <span class="p">}</span>
</span></span></code></pre></div><h3 id="throttlelatest">ThrottleLatest</h3>
<p>ThrottleLatest can be seen as some combination of throttleFirst and throttleLast. It will emit first item and start timer. Then when timer expires it would emit latest emitted value. But it won’t restart timer before new item emitted.</p>
<p><img src="../../img/1_rQUZS4HK-o5WtTut555gsA.png" alt=""></p>
<p>Here we expect values of 1, 3, 4, 5, 6, 7 to be emitted. Here value of 8 won’t be emitted because timer hasn’t expired after 7. And 9 won’t be emitted because stream completed before timer expired.</p>
<p>In RxJava we’ll use throttleLatest operator:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">testObservable</span> <span class="p">{</span> <span class="n">throttleLatest</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="nc">TimeUnit</span><span class="p">.</span><span class="n">MILLISECONDS</span><span class="p">)</span> <span class="p">}</span>
</span></span></code></pre></div><p>In Kotlin Flow again there is no such operator, but we can try to write implementation by our own.
Some java version which uses Timer can look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="nf">Flow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">throttleLatestJava</span><span class="p">(</span><span class="n">periodMillis</span><span class="p">:</span> <span class="n">Long</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">channelFlow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">var</span> <span class="py">lastValue</span><span class="p">:</span> <span class="n">T</span><span class="p">?</span>
</span></span><span class="line"><span class="cl">        <span class="k">var</span> <span class="py">timer</span><span class="p">:</span> <span class="n">Timer</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span></span><span class="line"><span class="cl">        <span class="n">onCompletion</span> <span class="p">{</span> <span class="n">timer</span><span class="o">?.</span><span class="n">cancel</span><span class="p">()</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="n">lastValue</span> <span class="p">=</span> <span class="k">value</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">timer</span> <span class="o">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">timer</span> <span class="p">=</span> <span class="n">Timer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="n">timer</span><span class="o">?.</span><span class="n">scheduleAtFixedRate</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="k">object</span> <span class="err">: </span><span class="nc">TimerTask</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">override</span> <span class="k">fun</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="k">val</span> <span class="py">value</span> <span class="p">=</span> <span class="n">lastValue</span>
</span></span><span class="line"><span class="cl">                            <span class="n">lastValue</span> <span class="p">=</span> <span class="k">null</span>
</span></span><span class="line"><span class="cl">                            <span class="k">if</span> <span class="p">(</span><span class="k">value</span> <span class="o">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="n">launch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                    <span class="n">send</span><span class="p">(</span><span class="k">value</span> <span class="k">as</span> <span class="n">T</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                <span class="n">timer</span><span class="o">?.</span><span class="n">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                                <span class="n">timer</span> <span class="p">=</span> <span class="k">null</span>
</span></span><span class="line"><span class="cl">                            <span class="p">}</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="m">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">periodMillis</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>It is quite big and uses Timer, which is based on Thread, so might not be good to be used in conjunction with coroutines.</p>
<p>We might want to write some version which uses coroutines only (similar to debounce):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@ExperimentalCoroutinesApi</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="nf">Flow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">throttleLatestKotlin</span><span class="p">(</span><span class="n">periodMillis</span><span class="p">:</span> <span class="n">Long</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">require</span><span class="p">(</span><span class="n">periodMillis</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&#34;period should be positive&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">channelFlow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">done</span> <span class="p">=</span> <span class="n">Any</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">values</span> <span class="p">=</span> <span class="n">produce</span><span class="p">(</span><span class="n">capacity</span> <span class="p">=</span> <span class="nc">Channel</span><span class="p">.</span><span class="n">CONFLATED</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">collect</span> <span class="p">{</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">send</span><span class="p">(</span><span class="k">value</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">var</span> <span class="py">lastValue</span><span class="p">:</span> <span class="n">Any</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span></span><span class="line"><span class="cl">        <span class="k">val</span> <span class="py">ticker</span> <span class="p">=</span> <span class="n">Ticker</span><span class="p">(</span><span class="n">periodMillis</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">lastValue</span> <span class="o">!==</span> <span class="n">done</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">select</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">values</span><span class="p">.</span><span class="n">onReceiveOrNull</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="k">it</span> <span class="o">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ticker</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                        <span class="n">lastValue</span> <span class="p">=</span> <span class="n">done</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">lastValue</span> <span class="p">=</span> <span class="k">it</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="p">(!</span><span class="n">ticker</span><span class="p">.</span><span class="n">isStarted</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                            <span class="n">ticker</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="k">this</span><span class="nd">@channelFlow</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="p">}</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">ticker</span><span class="p">.</span><span class="n">getTicker</span><span class="p">().</span><span class="n">onReceive</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">lastValue</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="k">val</span> <span class="py">value</span> <span class="p">=</span> <span class="n">lastValue</span>
</span></span><span class="line"><span class="cl">                        <span class="n">lastValue</span> <span class="p">=</span> <span class="k">null</span>
</span></span><span class="line"><span class="cl">                        <span class="n">send</span><span class="p">(</span><span class="k">value</span> <span class="k">as</span> <span class="n">T</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">ticker</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And here we’ll have to create special Ticker implementation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Ticker</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">delay</span><span class="p">:</span> <span class="n">Long</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">var</span> <span class="py">channel</span><span class="p">:</span> <span class="n">ReceiveChannel</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">Channel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">var</span> <span class="py">isStarted</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span>
</span></span><span class="line"><span class="cl">        <span class="k">private</span> <span class="k">set</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">getTicker</span><span class="p">():</span> <span class="n">ReceiveChannel</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">channel</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">start</span><span class="p">(</span><span class="n">scope</span><span class="p">:</span> <span class="n">CoroutineScope</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">isStarted</span> <span class="p">=</span> <span class="k">true</span>
</span></span><span class="line"><span class="cl">        <span class="n">channel</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">channel</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">produce</span><span class="p">(</span><span class="n">capacity</span> <span class="p">=</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">channel</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">delay</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">stop</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">isStarted</span> <span class="p">=</span> <span class="k">false</span>
</span></span><span class="line"><span class="cl">        <span class="n">channel</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">channel</span> <span class="p">=</span> <span class="n">Channel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">cancel</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">isStarted</span> <span class="p">=</span> <span class="k">false</span>
</span></span><span class="line"><span class="cl">        <span class="n">channel</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Usages of such operators will look like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">testFlow</span> <span class="p">{</span> <span class="n">throttleLatestKotlin</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">testFlow</span> <span class="p">{</span> <span class="n">throttleLatestJava</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span> <span class="p">}</span>
</span></span></code></pre></div><p>Though because of complexity and possible issues with threading I’d not recommend to use such operators in production code. I hope we’ll have some operators which will be inside standard library.</p>
<h2 id="conslusion">Conslusion</h2>
<p>As seen above in Kotlin Flow we have only 2 out of 4 operators for throttling. Though throttleFirst implementation is simple and straightforward, implementation of throttleLatest might be error-prone and it is better to wait until implementation is added to standard library.</p>
<p>Also need to draw attention that our own throttleFirst implementation would not respect TestCoroutineScope.</p>
<p>Lacking of operators in Kotlin Flow might lead to not so easy migration from RxJava.
Other than that it is good that we have debounce.</p>
<p>Hope this article was useful for you. If somebody wants to play with the sample — it can be found in <a href="https://gist.github.com/krossovochkin/3c7fcda19e732e7451831e97b165568f">this gist</a>.</p>
<p>Happy coding!</p>

</main>


<hr/>

<footer>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/about">About</a></li>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    <li class="menu-left"><a href="/apps">Apps</a></li>
    
    
    <li class="menu-right"><a rel="me" href="https://t.me/krossovochkin_newsletter" target="_blank"><i class="fa-brands fa-telegram fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://stackoverflow.com/users/1533933/krossovochkin" target="_blank"><i class="fa-brands fa-stack-overflow fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://linkedin.com/in/vasyadrobushkov" target="_blank"><i class="fa-brands fa-linkedin fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://facebook.com/vasya.drobushkov" target="_blank"><i class="fa-brands fa-facebook fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="/index.xml" target="_blank"><i class="fa-solid fa-rss fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://androiddev.social/@krossovochkin" target="_blank"><i class="fa-brands fa-mastodon fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://github.com/krossovochkin" target="_blank"><i class="fa-brands fa-github fa-l"></i></a></li>
    
  </ul>
</nav>

</footer>


</body>

</html>