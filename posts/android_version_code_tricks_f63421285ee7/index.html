<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Android Version Code Tricks :: Krossovochkin — Android Developer</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Introduction Version code is a special integer value which works as an internal version number. It is not visible to end users. Android system uses this number to protect against application downgrades — it is not possible to install new application with version code lower than in currently installed application. Developers can use version code for example for doing specific tasks on updating to specific version.
Version code is placed inside AndroidManifest, but usually it is inside *defaultConfig *in build." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://krossovochkin.github.io/posts/android_version_code_tricks_f63421285ee7/" />




<link rel="stylesheet" href="https://krossovochkin.github.io/assets/style.css">

  <link rel="stylesheet" href="https://krossovochkin.github.io/assets/yellow.css">






<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://krossovochkin.github.io/img/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="https://krossovochkin.github.io/img/favicon/yellow.png">



<meta name="twitter:card" content="summary" />

  <meta name="twitter:site" content="krossovochkin" />

<meta name="twitter:creator" content="krossovochkin" />


<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Android Version Code Tricks :: Krossovochkin">
<meta property="og:description" content="Introduction Version code is a special integer value which works as an internal version number. It is not visible to end users. Android system uses this number to protect against application downgrades — it is not possible to install new application with version code lower than in currently installed application. Developers can use version code for example for doing specific tasks on updating to specific version.
Version code is placed inside AndroidManifest, but usually it is inside *defaultConfig *in build." />
<meta property="og:url" content="https://krossovochkin.github.io/posts/android_version_code_tricks_f63421285ee7/" />
<meta property="og:site_name" content="Android Version Code Tricks" />

  <meta property="og:image" content="https://krossovochkin.github.io/">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2019-07-04 00:00:00 &#43;0000 UTC" />












</head>
<body class="">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Krossovochkin
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About me</a></li>
        
      
        
          <li><a href="/">Posts</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About me</a></li>
      
    
      
        <li><a href="/">Posts</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://krossovochkin.github.io/posts/android_version_code_tricks_f63421285ee7/">Android Version Code Tricks</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2019-07-04 
      </span>
    
    
    <span class="post-author">::
      Vasya Drobushkov
    </span>
    
  </div>

  

  

  

  <div class="post-content"><div>
        <h2 id="introduction">Introduction<a href="#introduction" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Version code is a special integer value which works as an internal version number. It is not visible to end users. Android system uses this number to protect against application downgrades — it is not possible to install new application with version code lower than in currently installed application.
Developers can use version code for example for doing specific tasks on updating to specific version.</p>
<p>Version code is placed inside <em>AndroidManifest</em>, but usually it is inside *defaultConfig *in <em>build.gradle</em> (from where it is populated to *AndroidManifest *during assemble).
Also it is possible to access version code from generated BuildConfig.VERSION_CODE.</p>
<p>When using CI it is also common that version code is provided from outside via gradle parameter:</p>
<pre><code>./gradlew assembleRelease -PversionCode=12
</code></pre>
<p>Though it might happen that one would like to add some custom version code logic inside build.gradle. The naive way is to do something like:</p>
<pre><code>defaultConfig {
    ...
    versionCode calculateVersionCode()
    ...
}
</code></pre>
<p>But this version has limitation that this config is default and we don’t have any information on what was the actual assemble variant (i.e. we can’t say that for debug build we want to have one value and for release — another one, as variants are not yet available there).</p>
<h2 id="variant-specific-version-code">Variant-specific Version code<a href="#variant-specific-version-code" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Inside <em>android</em> section we have access to application variants:</p>
<pre><code>android.applicationVariants
</code></pre>
<p>If we look inside Variant implementation we’ll see that in variant’s output there is method called setVersionCodeOverride:</p>
<p><img src="../../img/1_jYFt6AKQEEfLts8x_xWPkg.png" alt=""></p>
<p><img src="../../img/1_r5siIglz84s-CAKkpbhACQ.png" alt=""></p>
<p>Let’s try this option. First we’ll setup app and provide 1 as default versionCode and will override it to 2 for all variant outputs:</p>
<p><img src="../../img/1_Zb2rYB9NwkYlWv7WzdOnXQ.png" alt=""></p>
<p>But then if we look inside BuildConfig file we’ll see that version code is still set to 1. Though if we look into resulting *AndroidManifest *we’ll see version code correctly set to 2.
Bug or feature? Let’s find out what is happening.</p>
<p>Inside the code we can access version code from BuildConfig.VERSION_CODE or from PackageManager.packageInfo.versionCode:</p>
<p><img src="../../img/1_QYPXdSM6hRmsqkYU2qUkFA.png" alt=""></p>
<p>After we run code in Logcat we’ll see exactly what we’ve observed above:</p>
<p><img src="../../img/1_NJ-Afc0ZQb3c0liYW9C2yw.png" alt=""></p>
<p>The reason why this is happening is that in android gradle build tools there are two separate tasks for generating *BuildConfig *file and for processing <em>AndroidManifest</em>.</p>
<p>If we look inside *GenerateBuildConfig *we’ll see that VERSION_CODE property is generated from getVersionCode() method:</p>
<p><img src="../../img/1__54jAHC-MPi33AJpJmiN8Q.png" alt=""></p>
<p>And that getVersionCode refers to value stored in variantConfiguration:</p>
<p><img src="../../img/1_DCW18oMaKmJjxVCtO6DGVw.png" alt=""></p>
<p>Unlike generating *BuildConfig *in *ProcessApplicationManifest *we see that version code is retrieved from apkData.</p>
<p><img src="../../img/1_grekhtsztmKZXz7ZCV8Wkg.png" alt=""></p>
<p>If we check variantConfiguration and apkData before and after we set version code override:</p>
<p><img src="../../img/1_VNfzqZdwX79yUuIVSX8BbQ.png" alt=""></p>
<p>We’ll see that value inside output apkData was changed though original value in variantConfiguration remains the same (as expected):</p>
<p><img src="../../img/1_p7lijVOWWIbu_3r4WLdj5w.png" alt=""></p>
<p>As stated in <a href="https://issuetracker.google.com/issues/37008496">this issue</a> it is done intentionally for performance reasons.</p>
<h2 id="conclusion">Conclusion<a href="#conclusion" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Be careful if you use setVersionCodeOverride as you might have different version codes in *BuildConfig *and <em>AndroidManifest</em>.</p>
<p>Also according to documentation the recommended way to check version code is to access it via <em>PackageManager</em>, not via <em>BuildConfig</em>:
<a href="https://developer.android.com/studio/publish/versioning"><strong>Version your app | Android Developers</strong>
*The Android system uses your app&rsquo;s version information to protect against downgrades.The system does not use app…*developer.android.com</a></p>
<p>Even better is to have versioning logic outside of <em>build.gradle</em> and provide it via gradle parameter by your CI.</p>
<p>Also it is wise choice to not rely much in your codebase on BuildConfig.VERSION_CODE. For migration cases you’d better to introduce your own local versioning (as it is done with SQL databases).</p>
<p>Happy coding!</p>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://krossovochkin.github.io/posts/3x3x3_rubiks_cube_world_gif_alert_613d016d2ae7/">
                <span class="button__icon">←</span>
                <span class="button__text">3x3x3 Rubik’s cube world (GIF alert)</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://krossovochkin.github.io/posts/throttling_in_rxjava_2_d640ea5f7bf1/">
                <span class="button__text">Throttling in RxJava 2</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>© 2020 Vasya Drobushkov</span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
  <div class="footer__inner">
    <div class="copyright copyright--user">
      <a href="https://www.facebook.com/vasya.drobushkov">Facebook</a><a href="https://twitter.com/krossovochkin">Twitter</a>
    </div>
  </div>
</footer>

<script src="https://krossovochkin.github.io/assets/main.js"></script>
<script src="https://krossovochkin.github.io/assets/prism.js"></script>





  
</div>

</body>
</html>
