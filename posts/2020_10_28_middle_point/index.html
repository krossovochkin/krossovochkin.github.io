<!DOCTYPE html>
<html lang="en-us">
<head>
  <title>Middle Point</title>

  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="apple-touch-icon-144-precompressed.png"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <script src="https://kit.fontawesome.com/6d5aec2882.js" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="/css/style.css" />

  <link rel="me" href="https://androiddev.social/@krossovochkin" />

  
  <meta name="theme-color" content="#1e2327">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Middle Point">
  <meta name="twitter:description" content="Introduction Working with numbers in programming never was a simple thing. In math, we deal with various sets of numbers - whole numbers, rational, complex. All these sets are infinite - that means that for any number we can find another smaller one and one which is bigger. In programming when we work with numbers we deal with some subset of these sets - that many that can be represented with a given amount of bits. When we want to work with whole numbers we can use e.g. Integer, which are the numbers being able to be represented usually with 4 bits. For floating-point numbers - say Double - it is 8 bits. There is no plus or minus infinity (in Double there are &#43;/- infinity, though they are used for special cases).">

</head>

<body>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-YEWQ4T95D5"></script>
      <script>
        var doNotTrack = false;
        if ( true ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-YEWQ4T95D5');
        }
      </script>

<header>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/about">About</a></li>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    <li class="menu-left"><a href="/apps">Apps</a></li>
    
    
    <li class="menu-right"><a rel="me" href="https://t.me/krossovochkin_newsletter" target="_blank"><i class="fa-brands fa-telegram fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://stackoverflow.com/users/1533933/krossovochkin" target="_blank"><i class="fa-brands fa-stack-overflow fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://linkedin.com/in/vasyadrobushkov" target="_blank"><i class="fa-brands fa-linkedin fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://facebook.com/vasya.drobushkov" target="_blank"><i class="fa-brands fa-facebook fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="/index.xml" target="_blank"><i class="fa-solid fa-rss fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://androiddev.social/@krossovochkin" target="_blank"><i class="fa-brands fa-mastodon fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://github.com/krossovochkin" target="_blank"><i class="fa-brands fa-github fa-l"></i></a></li>
    
  </ul>
</nav>

</header>

<br/>


<div class="meta">

  
    <h1><span class="title">Middle Point</span></h1>
  
  
    <h3>October 28, 2020</h3>
  

</div>

<main>
<h3 id="introduction">Introduction</h3>
<p>Working with numbers in programming never was a simple thing. In math, we deal with various sets of numbers - whole numbers, rational, complex. All these sets are infinite - that means that for any number we can find another smaller one and one which is bigger. In programming when we work with numbers we deal with some subset of these sets - that many that can be represented with a given amount of bits.
When we want to work with whole numbers we can use e.g. Integer, which are the numbers being able to be represented usually with 4 bits. For floating-point numbers - say Double - it is 8 bits. There is no plus or minus infinity (in Double there are +/- infinity, though they are used for special cases).</p>
<p>Let&rsquo;s look at a simple problem: given start and end number - calculate number which is in the middle. That means that we need to find such a number, which distance both to start and end will be the same.<br>
In math this is a simple problem: <code>(a + b) / 2</code> is the number. Let&rsquo;s look at what difficulties we&rsquo;ll face while writing such a program.<br>
We&rsquo;ll start with Integers first and then take a look at floating-point numbers.</p>
<h3 id="design-api">Design API</h3>
<p>We&rsquo;d like to have a function that takes two numbers as parameters returning the middle point as a result. That means that for Integers we might have:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">middle</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">Int</span>
</span></span></code></pre></div><p>For Double:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">middle</span><span class="p">(</span><span class="n">start</span> <span class="n">Double</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">Double</span><span class="p">):</span> <span class="n">Double</span> 
</span></span></code></pre></div><p>And in general, if we would like to work with any number:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">middle</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">Number</span><span class="p">):</span> <span class="n">Number</span>
</span></span></code></pre></div><h3 id="analyze-solution-existence">Analyze solution existence</h3>
<p>As said before - we&rsquo;re dealing with a subset of numbers in programming. Therefore the first question we&rsquo;d like to answer is whether we&rsquo;ll have a solution for any given set of numbers.<br>
Here we have three situations:</p>
<ul>
<li>start is greater than the end. We can safely assume that start should not be greater than the end. In such a case no solution exists, because our logical rule is broken. That means that here we can throw an exception.<br>
Let&rsquo;s write a test for this:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Test</span><span class="p">(</span><span class="n">expected</span> <span class="p">=</span> <span class="n">IllegalArgumentException</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`if start greater than end then throws exception`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">middle</span><span class="p">(</span><span class="m">5</span><span class="p">,</span> <span class="m">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>start is equal to end. In such a case middle both points are in the same place - and the middle will be there as well. Therefore we can return either start or end as a result.<br>
This can be handled by this test case:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`if start == end then start`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">assertEquals</span><span class="p">(</span><span class="m">5</span><span class="p">,</span> <span class="n">middle</span><span class="p">(</span><span class="m">5</span><span class="p">,</span> <span class="m">5</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>start is less than the end. Here we can apply our general logic of calculating the middle point.</li>
</ul>
<p>With this our initial setup for a function will be:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">middle</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">Int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="p">&gt;</span> <span class="n">end</span><span class="p">)</span> <span class="k">throw</span> <span class="n">IllegalArgumentException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span> <span class="k">return</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="integer-naive-approach">Integer naive approach</h3>
<p>An additional case which we should cover with Integer numbers is a case when we have two numbers with odd distance. Assume we have <code>start = 3</code> and <code>end = 6</code>. The correct middle point here would be <code>4.5</code>. But it is not possible to represent such a number as Integer.<br>
To cover that case we&rsquo;ll introduce an exception - in such cases we&rsquo;ll return closest smaller to the real middle point number.<br>
This will be covered with:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`if distance is odd then returns closest smaller`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">assertEquals</span><span class="p">(</span><span class="m">4</span><span class="p">,</span> <span class="n">middle</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">6</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>For any other pair of points, we&rsquo;ll be able to have a solution. If <code>start</code> and <code>end</code> can be represented as Integers (they are in the subset of whole numbers which can be represented as Integer) middle point will be between them and that means solution also will be represented as Integer without issues.</p>
<p>The naive approach would be to apply our math knowledge, we&rsquo;ll write our function body:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">middle</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">Int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">(</span><span class="n">start</span> <span class="p">+</span> <span class="n">end</span><span class="p">)</span> <span class="p">/</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>But this would be incorrect because if <code>start = 1</code> and <code>end = Int.MAX_VALUE</code> then <code>start + end</code> overflows and the result will be negative.</p>
<h3 id="integer-handling-overflow">Integer handling overflow</h3>
<p>That means that whenever we design a function that works with numbers, we need to consider that not all whole numbers can be represented as Integer. Specifically, we need to carefully take a look at boundaries.<br>
For handling this there is a good trick:</p>
<pre tabindex="0"><code>(a + b) / 2 = a / 2 + b / 2 = a - a / 2 + b / 2 = a + (b - a) / 2
</code></pre><p>With a simple trick, we now avoid the sum of big numbers therefore our case with <code>start = 1</code> and <code>end = Int.MAX_VALUE</code> now works correctly. So, our function will be:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">middle</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">Int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">..</span><span class="p">.</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">start</span> <span class="p">+</span> <span class="p">(</span><span class="n">end</span> <span class="p">-</span> <span class="n">start</span><span class="p">)</span> <span class="p">/</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>But now we have subtraction, which means we need to pay attention to <code>Int.MIN_VALUE</code> as well. What if we have <code>start = Int.MIN_VALUE</code> and <code>end = 5</code>. Now we have an overflow again.</p>
<p>After considering all of this we come up with a solution: depending on whether start and end have same sign or different, we&rsquo;ll use different formula. And the function will be:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">middle</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">Int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">when</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="p">&gt;</span> <span class="n">end</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="n">IllegalArgumentException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="o">==</span> <span class="n">end</span> <span class="o">-&gt;</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="p">&lt;</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="n">end</span> <span class="p">&gt;</span> <span class="m">0</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">start</span> <span class="p">+</span> <span class="n">end</span><span class="p">)</span> <span class="p">/</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="o">-&gt;</span> <span class="n">start</span> <span class="p">+</span> <span class="p">(</span><span class="n">end</span> <span class="p">-</span> <span class="n">start</span><span class="p">)</span> <span class="p">/</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And the set of tests:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`if start greater than 0 and end greater than 0 and no overflow`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">assertEquals</span><span class="p">(</span><span class="m">6</span><span class="p">,</span> <span class="n">middle</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">11</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`if start greater than 0 and end greater than 0 and has overflow`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">assertEquals</span><span class="p">(</span><span class="nc">Int</span><span class="p">.</span><span class="n">MAX_VALUE</span> <span class="p">-</span> <span class="m">1</span><span class="p">,</span> <span class="n">middle</span><span class="p">(</span><span class="nc">Int</span><span class="p">.</span><span class="n">MAX_VALUE</span> <span class="p">-</span> <span class="m">2</span><span class="p">,</span> <span class="nc">Int</span><span class="p">.</span><span class="n">MAX_VALUE</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`if start less than 0 and end less than 0 and no overflow`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">assertEquals</span><span class="p">(-</span><span class="m">6</span><span class="p">,</span> <span class="n">middle</span><span class="p">(-</span><span class="m">11</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`if start less than 0 and end less than 0 and has overflow`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">assertEquals</span><span class="p">(</span><span class="nc">Int</span><span class="p">.</span><span class="n">MIN_VALUE</span> <span class="p">+</span> <span class="m">1</span><span class="p">,</span> <span class="n">middle</span><span class="p">(</span><span class="nc">Int</span><span class="p">.</span><span class="n">MIN_VALUE</span> <span class="p">+</span> <span class="m">1</span><span class="p">,</span> <span class="nc">Int</span><span class="p">.</span><span class="n">MIN_VALUE</span> <span class="p">+</span> <span class="m">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`if start less than 0 and end greater than 0 and no overflow`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">assertEquals</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="n">middle</span><span class="p">(-</span><span class="m">4</span><span class="p">,</span> <span class="m">6</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`if start less than 0 and end greater than 0 and has overflow`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">assertEquals</span><span class="p">(-</span><span class="m">1</span><span class="p">,</span> <span class="n">middle</span><span class="p">(</span><span class="nc">Int</span><span class="p">.</span><span class="n">MIN_VALUE</span><span class="p">,</span> <span class="nc">Int</span><span class="p">.</span><span class="n">MAX_VALUE</span> <span class="p">-</span> <span class="m">1</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Not as simple as was at first thought.</p>
<h3 id="double-naive-approach">Double naive approach</h3>
<p>Now let&rsquo;s look at Double. Here we can be sure that we&rsquo;ll be able to represent the result correctly for the case when the middle point can&rsquo;t be represented as an Integer because of the decimal part.</p>
<p>Let&rsquo;s just copy-paste our function changing Int to Double:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">middle</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="n">Double</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">Double</span><span class="p">):</span> <span class="n">Double</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">when</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="p">&gt;</span> <span class="n">end</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="n">IllegalArgumentException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="o">==</span> <span class="n">end</span> <span class="o">-&gt;</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="p">&lt;</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="n">end</span> <span class="p">&gt;</span> <span class="m">0</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">start</span> <span class="p">+</span> <span class="n">end</span><span class="p">)</span> <span class="p">/</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="o">-&gt;</span> <span class="n">start</span> <span class="p">+</span> <span class="p">(</span><span class="n">end</span> <span class="p">-</span> <span class="n">start</span><span class="p">)</span> <span class="p">/</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Are we good? Not really. With floating-point numbers, one should work carefully because of precision. While with Integers it is not possible to represent numbers less than <code>Int.MIN_VALUE</code> and greater than <code>Int.MAX_VALUE</code> and points in between two closest Integer values, with doubles we might not preserve exact numbers in between two points with the required precision.</p>
<p>Consider the following test:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`double inexact`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">assertEquals</span><span class="p">(</span><span class="m">0.45</span><span class="p">,</span> <span class="n">middle</span><span class="p">(</span><span class="m">0.3</span><span class="p">,</span> <span class="m">0.6</span><span class="p">),</span> <span class="m">1.0e-17</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The solution should be <code>0.45</code>, but after math applied to Double numbers, there might be an error. And instead of <code>0.45</code>, we&rsquo;ll get <code>0.44999999999999</code>. That is why when doing a comparison we have to add precision. If we take say <code>1.0e-16</code> - test passes. But if we take <code>1.0e-17</code> - it fails, because the result can be represented with the required precision. This is something we should be aware of. Our function will return the best possible result.</p>
<h3 id="double-infinity">Double infinity</h3>
<p>With Double, we not only have <code>Double.MIN_VALUE</code> and <code>Double.MAX_VALUE</code>. Also, we have <code>Double.NEGATIVE_INFINITY</code> and <code>Double.POSITIVE_INFINITY</code>. These are special values and let&rsquo;s look at how our implementation works with them.<br>
But first, let&rsquo;s think about the expected results.</p>
<p>We might say that if start or end is represented as infinity then the result is unknown. We don&rsquo;t know how far we can go with either. So, the simplest thing we can do is to check for these values and, for example, throw an exception.<br>
But also we can do some additional calculations.<br>
For example, if we have <code>start = Double.NEGATIVE_INFINITY</code> and <code>end = Double.NEGATIVE_INFINITY</code>? Our start and end both the same, so it feels that we can return <code>Double.NEGATIVE_INFINITY</code> as a result. Same for <code>Double.POSITIVE_INFINITY</code>. And this case is already covered by our check for <code>start == end</code>.</p>
<p>What about one number is infinity and another is not? Can we assume that result should be infinity as well? I guess so. Because whatever we sum with infinity - the result will be infinity again.</p>
<p>And what about the case when <code>start == Double.NEGATIVE_INFINITY</code> and <code>end == Double.POSITIVE_INFINITY</code>? Here the result is undefined. We don&rsquo;t know what is bigger - negative infinity or positive infinity. We could speculate that result should be <code>0</code>. And probably it is up to a designer of the method. I think that in such a case it is better to throw an exception.</p>
<p>And our set of tests is now should have:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Test</span><span class="p">(</span><span class="n">expected</span> <span class="p">=</span> <span class="n">IllegalArgumentException</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`double start is negative infinity and end is positive infinity then throws exception`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">middle</span><span class="p">(</span><span class="nc">Double</span><span class="p">.</span><span class="n">NEGATIVE_INFINITY</span><span class="p">,</span> <span class="nc">Double</span><span class="p">.</span><span class="n">POSITIVE_INFINITY</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`double start is negative infinity and end is not infinity then negative infinity`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">assertEquals</span><span class="p">(</span><span class="nc">Double</span><span class="p">.</span><span class="n">NEGATIVE_INFINITY</span><span class="p">,</span> <span class="n">middle</span><span class="p">(</span><span class="nc">Double</span><span class="p">.</span><span class="n">NEGATIVE_INFINITY</span><span class="p">,</span> <span class="nc">Double</span><span class="p">.</span><span class="n">MAX_VALUE</span><span class="p">),</span> <span class="m">1.0e-16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`double start is not infinity and end is positive infinity then positive infinity`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">assertEquals</span><span class="p">(</span><span class="nc">Double</span><span class="p">.</span><span class="n">POSITIVE_INFINITY</span><span class="p">,</span> <span class="n">middle</span><span class="p">(</span><span class="nc">Double</span><span class="p">.</span><span class="n">MIN_VALUE</span><span class="p">,</span> <span class="nc">Double</span><span class="p">.</span><span class="n">POSITIVE_INFINITY</span><span class="p">),</span> <span class="m">1.0e-16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`double start == end == negative infinity then negative infinity`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">assertEquals</span><span class="p">(</span><span class="nc">Double</span><span class="p">.</span><span class="n">NEGATIVE_INFINITY</span><span class="p">,</span> <span class="n">middle</span><span class="p">(</span><span class="nc">Double</span><span class="p">.</span><span class="n">NEGATIVE_INFINITY</span><span class="p">,</span> <span class="nc">Double</span><span class="p">.</span><span class="n">NEGATIVE_INFINITY</span><span class="p">),</span> <span class="m">1.0e-16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`double start == end == positive infinity then positive infinity`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">assertEquals</span><span class="p">(</span><span class="nc">Double</span><span class="p">.</span><span class="n">POSITIVE_INFINITY</span><span class="p">,</span> <span class="n">middle</span><span class="p">(</span><span class="nc">Double</span><span class="p">.</span><span class="n">POSITIVE_INFINITY</span><span class="p">,</span> <span class="nc">Double</span><span class="p">.</span><span class="n">POSITIVE_INFINITY</span><span class="p">),</span> <span class="m">1.0e-16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And our fixed solution for Double now looks like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">middle</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="n">Double</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">Double</span><span class="p">):</span> <span class="n">Double</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">when</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="o">==</span> <span class="nc">Double</span><span class="p">.</span><span class="n">NEGATIVE_INFINITY</span> <span class="o">&amp;&amp;</span> <span class="n">end</span> <span class="o">==</span> <span class="nc">Double</span><span class="p">.</span><span class="n">POSITIVE_INFINITY</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="n">IllegalArgumentException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="p">&gt;</span> <span class="n">end</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="n">IllegalArgumentException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="o">==</span> <span class="n">end</span> <span class="o">-&gt;</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="p">&lt;</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="n">end</span> <span class="p">&gt;</span> <span class="m">0</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">start</span> <span class="p">+</span> <span class="n">end</span><span class="p">)</span> <span class="p">/</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="o">-&gt;</span> <span class="n">start</span> <span class="p">+</span> <span class="p">(</span><span class="n">end</span> <span class="p">-</span> <span class="n">start</span><span class="p">)</span> <span class="p">/</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="double-nan">Double NaN</h3>
<p>There is yet another special value in Double - <code>Double.NaN</code>. Here the solution is simple: if either start or end is <code>Double.NaN</code> then we should throw an exception, as we can&rsquo;t calculate the result.</p>
<p>We add two more test cases:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Test</span><span class="p">(</span><span class="n">expected</span> <span class="p">=</span> <span class="n">IllegalArgumentException</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`start == NaN then throws exception`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">middle</span><span class="p">(</span><span class="nc">Double</span><span class="p">.</span><span class="n">NaN</span><span class="p">,</span> <span class="m">1.0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Test</span><span class="p">(</span><span class="n">expected</span> <span class="p">=</span> <span class="n">IllegalArgumentException</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">`end == NaN then throws exception`</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">middle</span><span class="p">(</span><span class="m">1.0</span><span class="p">,</span> <span class="nc">Double</span><span class="p">.</span><span class="n">NaN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And adjust our function to handle that:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">middle</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="n">Double</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">Double</span><span class="p">):</span> <span class="n">Double</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">when</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span><span class="p">.</span><span class="n">isNaN</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="n">IllegalArgumentException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">end</span><span class="p">.</span><span class="n">isNaN</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="n">IllegalArgumentException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="o">==</span> <span class="nc">Double</span><span class="p">.</span><span class="n">NEGATIVE_INFINITY</span> <span class="o">&amp;&amp;</span> <span class="n">end</span> <span class="o">==</span> <span class="nc">Double</span><span class="p">.</span><span class="n">POSITIVE_INFINITY</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="n">IllegalArgumentException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="p">&gt;</span> <span class="n">end</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="n">IllegalArgumentException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="o">==</span> <span class="n">end</span> <span class="o">-&gt;</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="p">&lt;</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="n">end</span> <span class="p">&gt;</span> <span class="m">0</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">start</span> <span class="p">+</span> <span class="n">end</span><span class="p">)</span> <span class="p">/</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="o">-&gt;</span> <span class="n">start</span> <span class="p">+</span> <span class="p">(</span><span class="n">end</span> <span class="p">-</span> <span class="n">start</span><span class="p">)</span> <span class="p">/</span> <span class="m">2</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>One thing to note is that it is tempting to make a comparison with <code>start == Double.NaN</code>, but it would be a mistake.<br>
If we look at implementation of <code>isNan</code> method, we&rsquo;ll see the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isNaN</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">v</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><code>Double.NaN</code> is not equal to itself, so <code>start == Double.NaN</code> would be incorrect.</p>
<blockquote>
<p>With Double it is possible to not throw an exception but instead in exceptional cases return <code>Double.NaN</code>. It is again totally acceptable and depends on the API designer&rsquo;s decision.</p>
</blockquote>
<h3 id="number">Number</h3>
<p>Let&rsquo;s say we&rsquo;d like to write a general function for any Number. We have various options:</p>
<ul>
<li>create a separate option for any type of Number (though we wouldn&rsquo;t handle the case with some third party implementations). This way we will check the type of provided number and choose the correct function with some fallback (probably Double or BigDecimal)</li>
<li>create a single version which under the hood will use the broadest type - say BigDecimal. Then the client will convert the result to the required Number implementation. This will give us a single method, though it will be heavier in terms of resources.</li>
</ul>
<p>For simplicity, let&rsquo;s go with the second option.</p>
<p>Here we can apply just something like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">middle</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span> <span class="n">end</span><span class="p">:</span> <span class="n">Number</span><span class="p">):</span> <span class="n">Number</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">a</span> <span class="p">=</span> <span class="n">start</span><span class="p">.</span><span class="n">toString</span><span class="p">().</span><span class="n">toBigDecimal</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">b</span> <span class="p">=</span> <span class="n">end</span><span class="p">.</span><span class="n">toString</span><span class="p">().</span><span class="n">toBigDecimal</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">when</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span> <span class="p">&gt;</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="k">throw</span> <span class="n">IllegalArgumentException</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span> <span class="p">&lt;</span> <span class="nc">BigDecimal</span><span class="p">.</span><span class="n">ZERO</span> <span class="o">&amp;&amp;</span> <span class="n">b</span> <span class="p">&gt;</span> <span class="nc">BigDecimal</span><span class="p">.</span><span class="n">ZERO</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">a</span> <span class="p">+</span> <span class="n">b</span><span class="p">)</span> <span class="p">/</span> <span class="m">2.</span><span class="n">toBigDecimal</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="p">+</span> <span class="p">(</span><span class="n">b</span> <span class="p">-</span> <span class="n">a</span><span class="p">)</span> <span class="p">/</span> <span class="m">2.</span><span class="n">toBigDecimal</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>First, we&rsquo;ll check for our initial equality to avoid redundant conversion.
Then we first convert numbers to string and then to BigDecimal. We do that to avoid losing information.
Finally, we have our usual checks. Thanks to Kotlin operator overload it looks pretty well with <code>+</code> instead of <code>plus</code>.</p>
<h3 id="conclusion">Conclusion</h3>
<p>In this article, I wanted to show two things. First, that math as we study it at university and math in programming are two different things. In programming, we face additional limitations that we can&rsquo;t ignore. Second that even some small and simple functions require thorough API design. Depending on what our goal is, what constraints we have, how we&rsquo;d like to approach the corner and exceptional cases (fail fast or continue gracefully) we&rsquo;ll have different results.<br>
Pay attention to details, apply as much care to the system and its smaller parts.</p>
<p>Happy coding.</p>

</main>


<hr/>

<footer>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/about">About</a></li>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    <li class="menu-left"><a href="/apps">Apps</a></li>
    
    
    <li class="menu-right"><a rel="me" href="https://t.me/krossovochkin_newsletter" target="_blank"><i class="fa-brands fa-telegram fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://stackoverflow.com/users/1533933/krossovochkin" target="_blank"><i class="fa-brands fa-stack-overflow fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://linkedin.com/in/vasyadrobushkov" target="_blank"><i class="fa-brands fa-linkedin fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://facebook.com/vasya.drobushkov" target="_blank"><i class="fa-brands fa-facebook fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="/index.xml" target="_blank"><i class="fa-solid fa-rss fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://androiddev.social/@krossovochkin" target="_blank"><i class="fa-brands fa-mastodon fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://github.com/krossovochkin" target="_blank"><i class="fa-brands fa-github fa-l"></i></a></li>
    
  </ul>
</nav>

</footer>


</body>

</html>