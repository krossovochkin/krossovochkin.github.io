<!DOCTYPE html>
<html lang="en-us">
<head>
  <title>From RxJava to Kotlin Flow: Backpressure</title>

  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="apple-touch-icon-144-precompressed.png"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <script src="https://kit.fontawesome.com/6d5aec2882.js" crossorigin="anonymous"></script>

  <script src="https://cdn.counter.dev/script.js" data-id="2d1779da-dc31-440f-8099-940355d12f4d" data-utcoffset="2"></script>
  
  <link rel="stylesheet" href="/css/style.css" />

  <link rel="me" href="https://androiddev.social/@krossovochkin" />

  
  <meta name="theme-color" content="#1e2327">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="From RxJava to Kotlin Flow: Backpressure">
  <meta name="twitter:description" content="Quick comparison between backpressure solutions in RxJava and Kotlin Flow">

</head>

<body>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-YEWQ4T95D5"></script>
      <script>
        var doNotTrack = false;
        if ( true ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-YEWQ4T95D5');
        }
      </script>

<header>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/about">About</a></li>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    <li class="menu-left"><a href="/apps">Apps</a></li>
    
    
    <li class="menu-right"><a rel="me" href="https://t.me/krossovochkin_newsletter" target="_blank"><i class="fa-brands fa-telegram fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://stackoverflow.com/users/1533933/krossovochkin" target="_blank"><i class="fa-brands fa-stack-overflow fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://linkedin.com/in/vasyadrobushkov" target="_blank"><i class="fa-brands fa-linkedin fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://facebook.com/vasya.drobushkov" target="_blank"><i class="fa-brands fa-facebook fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="/index.xml" target="_blank"><i class="fa-solid fa-rss fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://androiddev.social/@krossovochkin" target="_blank"><i class="fa-brands fa-mastodon fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://github.com/krossovochkin" target="_blank"><i class="fa-brands fa-github fa-l"></i></a></li>
    
  </ul>
</nav>

</header>

<br/>


<div class="meta">

  
    <h1><span class="title">From RxJava to Kotlin Flow: Backpressure</span></h1>
  
  
    <h3>February 6, 2020</h3>
  

</div>

<main>
<p><a href="https://proandroiddev.com/from-rxjava-to-kotlin-flow-backpressure-d1fb91e6dea8"><img src="https://img.shields.io/badge/original-proandroiddev-green#badge" alt=""></a> <a href="https://androidweekly.net/issues/issue-400"><img src="https://img.shields.io/badge/androidweekly-400-blue#badge" alt=""></a> <a href="https://proandroiddev.com/proandroiddev-digest-15-b467005869ce"><img src="https://img.shields.io/badge/proandroiddevdigest-15-green#badge" alt=""></a></p>
<blockquote>
<p>Disclaimer
This article unfortunately is not that dive deep (because of complexity of internals of coroutines), but instead trying to compare RxJava and Kotlin Flow mostly as black box with trying to find out differences in behavior and how to migrate from RxJava with its backpressure solution to Kotlin Flow.
Hopefully this article will give you direction on where to look at if you decide to migrate to Kotlin Flow.</p>
</blockquote>
<p>This is somewhat continuation to previous article about comparison of RxJava and Kotlin Flow. If you haven’t read previous article you can find it here:
<a href="https://proandroiddev.com/from-rxjava-2-to-kotlin-flow-threading-8618867e1955">From RxJava 2 to Kotlin Flow: Threading</a></p>
<p><img src="https://images.unsplash.com/photo-1530122577122-6b8010d1a6b3?ixlib=rb-1.2.1&amp;auto=format&amp;fit=crop&amp;w=1357&amp;q=80" alt="Source"><a href="https://unsplash.com/photos/Y3brPR0gjb4">Source</a></p>
<h2 id="introduction">Introduction</h2>
<p>Backpressure is a term in reactive streams which describes the behavior when consumer is not consuming events that fast as producer produces them.
Not having backpressure might lead to either blocking you code (if consumer blocks until takes next event) or OutOfMemoryErrors (if producer caches its events for consumer).
RxJava is known for its first class support for backpressure. Kotlin Flow also has some solutions for that problem.
In this article we’ll try to compare solutions and find out what one should pay attention to to successfully migrate from one library to another.</p>
<h2 id="rxjava-backpressure">RxJava Backpressure</h2>
<p>In RxJava there are a lot of reactive types (Observable, Single etc.), but only Flowable is a type which supports backpressure in RxJava.
It is supported via Subscriber interface:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Subscriber</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onSubscribe</span><span class="p">(</span><span class="n">Subscription</span><span class="w"> </span><span class="n">s</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onNext</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">t</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onError</span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">t</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onComplete</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>The main thing about backpressure is inside Subscripion interface:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">Subscription</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">request</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">n</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">cancel</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>Particularly request method.
Whenever downstream is able to consume more events, it sends request to upstream providing number of events it is able to consume.</p>
<p>So, basic communication is the following:</p>
<p>on subscribe downstream requests some number of events (say 1)</p>
<p>upstream receives that request and produces next event</p>
<p>when downstream receives event it can request upstream to more events</p>
<p>This is how backpressure is supported: if downstream not requested events, producer should stop producing events. If some backpressure strategy is applied and producer is able to emit new item and consumer is not able to consume it, then producer might discard some values or buffer them.</p>
<p>This might be considered as communication from bottom to top of the chain to tell the upstream whether or not to emit values, and (based on backpressure strategy) apply some rules on values which are no ready to be emitted to consumer.</p>
<h2 id="kotlin-flow-backpressure">Kotlin Flow Backpressure</h2>
<p>In Kotlin Flow everything is more complicated, as there is no direct communication from downstream to upstream. What is Kotlin Flow backpressure is based on is suspension. When downstream is suspended (or doing some work) upstream might identify that and not produce items.</p>
<h2 id="comparison-setup">Comparison setup</h2>
<p>In order to make a comparison we’ll make some setup.
First of all we’ll make some helper functions which describe some work in progress (like loading some data from network).</p>
<p>For RxJava it will be blocking:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">fun</span> <span class="nf">doWorkBlocking</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">delay</span><span class="p">:</span> <span class="n">Long</span><span class="p">):</span> <span class="n">Int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nc">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And for Koltlin Flow suspending:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">doWorkDelay</span><span class="p">(</span><span class="n">i</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span><span class="p">):</span> <span class="n">Int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">delay</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">i</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Next we’ll create some upstreams which produce some events with predefined delay.</p>
<p>For RxJava:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">fun</span> <span class="nf">flowable</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">delay</span><span class="p">:</span> <span class="n">Long</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">mode</span><span class="p">:</span> <span class="n">BackpressureStrategy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span><span class="p">:</span> <span class="n">Int</span>
</span></span><span class="line"><span class="cl"><span class="p">):</span> <span class="n">Flowable</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">Flowable</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="n">create</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;(</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span> <span class="n">emitter</span><span class="p">:</span> <span class="n">FlowableEmitter</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nc">Thread</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">emitter</span><span class="p">.</span><span class="n">onNext</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">emitter</span><span class="p">.</span><span class="n">onComplete</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">mode</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span></code></pre></div><p>And for Kotlin Flow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">fun</span> <span class="nf">flow</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span><span class="p">:</span> <span class="n">Int</span>
</span></span><span class="line"><span class="cl"><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="m">1.</span><span class="p">.</span><span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">delay</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>For these functions we’ll have streams which emit limit + 1 items with timeout delay between each event.</p>
<p>Next we’ll have our test functions which we’ll use to verify output and print some time needed to produce that output (not for benchmark purposes, but to see that time is relatively equal).</p>
<p>For RxJava it will be:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">fun</span> <span class="nf">testFlowable</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">mode</span><span class="p">:</span> <span class="n">BackpressureStrategy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">10</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">latch</span> <span class="p">=</span> <span class="n">CountDownLatch</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">stringBuffer</span> <span class="p">=</span> <span class="n">StringBuffer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">time</span> <span class="p">=</span> <span class="nc">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">flowable</span><span class="p">(</span><span class="n">delay</span> <span class="p">=</span> <span class="m">100</span><span class="p">,</span> <span class="n">mode</span> <span class="p">=</span> <span class="n">mode</span><span class="p">,</span> <span class="n">limit</span> <span class="p">=</span> <span class="n">limit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">subscribeOn</span><span class="p">(</span><span class="nc">Schedulers</span><span class="p">.</span><span class="n">io</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">observeOn</span><span class="p">(</span><span class="nc">Schedulers</span><span class="p">.</span><span class="n">computation</span><span class="p">(),</span> <span class="k">false</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">doWorkBlocking</span><span class="p">(</span><span class="n">i</span> <span class="p">=</span> <span class="k">it</span><span class="p">,</span> <span class="n">delay</span> <span class="p">=</span> <span class="m">200</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">doWorkBlocking</span><span class="p">(</span><span class="n">i</span> <span class="p">=</span> <span class="k">it</span><span class="p">,</span> <span class="n">delay</span> <span class="p">=</span> <span class="m">300</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">doOnComplete</span> <span class="p">{</span> <span class="n">latch</span><span class="p">.</span><span class="n">countDown</span><span class="p">()</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">subscribe</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">stringBuffer</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$it</span><span class="s2"> &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">latch</span><span class="p">.</span><span class="n">await</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">((</span><span class="nc">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span> <span class="p">-</span> <span class="n">time</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="n">stringBuffer</span><span class="p">.</span><span class="n">toString</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>For Kotlin Flow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">fun</span> <span class="nf">testFlow</span><span class="p">(</span><span class="n">limit</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">10</span><span class="p">,</span> <span class="n">onBackpressure</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;.()</span> <span class="o">-&gt;</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">latch</span> <span class="p">=</span> <span class="n">CountDownLatch</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">time</span> <span class="p">=</span> <span class="nc">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">stringBuffer</span> <span class="p">=</span> <span class="n">StringBuffer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">CoroutineScope</span><span class="p">(</span><span class="n">Job</span><span class="p">()</span> <span class="p">+</span> <span class="nc">Dispatchers</span><span class="p">.</span><span class="n">Default</span><span class="p">).</span><span class="n">launch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">flow</span><span class="p">(</span><span class="n">timeout</span> <span class="p">=</span> <span class="m">100</span><span class="p">,</span> <span class="n">limit</span> <span class="p">=</span> <span class="n">limit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">flowOn</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">onBackpressure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">doWorkDelay</span><span class="p">(</span><span class="n">i</span> <span class="p">=</span> <span class="k">it</span><span class="p">,</span> <span class="n">timeout</span> <span class="p">=</span> <span class="m">200</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">doWorkDelay</span><span class="p">(</span><span class="n">i</span> <span class="p">=</span> <span class="k">it</span><span class="p">,</span> <span class="n">timeout</span> <span class="p">=</span> <span class="m">300</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">onCompletion</span> <span class="p">{</span> <span class="n">latch</span><span class="p">.</span><span class="n">countDown</span><span class="p">()</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">collect</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">stringBuffer</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$it</span><span class="s2"> &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">latch</span><span class="p">.</span><span class="n">await</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">((</span><span class="nc">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span> <span class="p">-</span> <span class="n">time</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="n">stringBuffer</span><span class="p">.</span><span class="n">toString</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>As seen above we’ll have our upstream to produce item each 100ms with processing them sequentially with 200ms and then 300ms.</p>
<p>With such setup we expect that (as for consumer it takes about 500ms to process result) that not all events will be consumed.</p>
<h2 id="backpressure-latest">Backpressure Latest</h2>
<p>Backpressure Latest is a strategy which discards any item while consumer is still busy while keeping the latest item from producer:</p>
<p><img src="../../img/0_Vzqk9Z-RsW8USmYD.png" alt="Source"><a href="http://reactivex.io/documentation/operators/images/bp.obp.latest.png">Source</a></p>
<p>For RxJava in our test will have to run:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">testFlowable</span><span class="p">(</span><span class="n">LATEST</span><span class="p">)</span>
</span></span></code></pre></div><p>For Kotlin Flow the equivalent is:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">testFlow</span> <span class="p">{</span> <span class="n">conflate</span><span class="p">()</span> <span class="p">}</span>
</span></span></code></pre></div><p>The produced results will be somewhere:</p>
<pre tabindex="0"><code>1759
1 5 10
</code></pre><h2 id="backpressure-buffer">Backpressure Buffer</h2>
<p>Backpressure buffer is a strategy where upstream buffers items until they are consumed by consumer.</p>
<p><img src="../../img/0_-I1YmIr5hkq-syTQ.png" alt="Source"><a href="http://reactivex.io/documentation/operators/images/bp.obp.buffer.png">Source</a></p>
<p>For RxJava our test will look like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">testFlowable</span><span class="p">(</span><span class="n">BUFFER</span><span class="p">)</span>
</span></span></code></pre></div><p>And for Kotlin Flow it will be:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">testFlow</span> <span class="p">{</span> <span class="n">buffer</span><span class="p">()</span> <span class="p">}</span>
</span></span></code></pre></div><p>The result of execution will be printed somewhat like:</p>
<pre tabindex="0"><code>5114
1 2 3 4 5 6 7 8 9 10
</code></pre><p>And that’s expected: all the items are buffered and consumer is able to consume all items when it is ready.</p>
<h2 id="backpressure-drop">Backpressure Drop</h2>
<p>Next strategy is Drop. In this case (similarly to Latest) producer will discard all items consumer is not able to consume with exception that latest item will not be kept:</p>
<p><img src="../../img/0_rYU9jORYbGPlImvd.png" alt="Source"><a href="http://reactivex.io/documentation/operators/images/bp.obp.drop.png">Source</a></p>
<p>For RxJava we’ll use:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">testFlowable</span><span class="p">(</span><span class="n">DROP</span><span class="p">)</span>
</span></span></code></pre></div><p>With Kotlin flow it would be more difficult.
There is no ready to use operator.
I’ve asked on Stackoverflow and with help of <a href="undefined">Dávid Karnok</a> we now have some implementation for this strategy.</p>
<p>UPDATE: after various discussions in comments, in StackOverflow etc. seems the most straightforward implementation for drop is:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;</span> <span class="nf">Flow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">onBackpressureDrop</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">channelFlow</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">collect</span> <span class="p">{</span> <span class="n">offer</span><span class="p">(</span><span class="k">it</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}.</span><span class="n">buffer</span><span class="p">(</span><span class="n">capacity</span> <span class="p">=</span> <span class="m">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span></code></pre></div><p>This is a combination of offer method over channel which drops values if there is suspension, and buffer with capacity of 0, which suspends on each item received.</p>
<p>See answers here:
<a href="https://stackoverflow.com/a/59917873/1533933">Kotlin Flow onBackpressureDrop RxJava2 analog</a></p>
<p>With that answer in mind we can write something like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="n">testFlow</span> <span class="p">{</span> <span class="n">onBackpressureDrop</span><span class="p">()</span> <span class="p">}</span>
</span></span></code></pre></div><p>And the result will be:</p>
<pre tabindex="0"><code>1104
1 6
</code></pre><h2 id="flatmap">flatMap</h2>
<p>So far so good. We were able to find exact replacements to each backpressure strategy of RxJava in Kotlin Flow.
Though let’s modify our test sample a bit with including flatMap operator in it.</p>
<p>For RxJava:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">fun</span> <span class="nf">testFlowable</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">mode</span><span class="p">:</span> <span class="n">BackpressureStrategy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">10</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">latch</span> <span class="p">=</span> <span class="n">CountDownLatch</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">stringBuffer</span> <span class="p">=</span> <span class="n">StringBuffer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">time</span> <span class="p">=</span> <span class="nc">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">flowable</span><span class="p">(</span><span class="n">delay</span> <span class="p">=</span> <span class="m">100</span><span class="p">,</span> <span class="n">mode</span> <span class="p">=</span> <span class="n">mode</span><span class="p">,</span> <span class="n">limit</span> <span class="p">=</span> <span class="n">limit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">subscribeOn</span><span class="p">(</span><span class="nc">Schedulers</span><span class="p">.</span><span class="n">io</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">observeOn</span><span class="p">(</span><span class="nc">Schedulers</span><span class="p">.</span><span class="n">computation</span><span class="p">(),</span> <span class="k">false</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">doWorkBlocking</span><span class="p">(</span><span class="n">i</span> <span class="p">=</span> <span class="k">it</span><span class="p">,</span> <span class="n">delay</span> <span class="p">=</span> <span class="m">200</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nc">Flowable</span><span class="p">.</span><span class="n">just</span><span class="p">(</span><span class="k">it</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">doWorkBlocking</span><span class="p">(</span><span class="n">i</span> <span class="p">=</span> <span class="k">it</span><span class="p">,</span> <span class="n">delay</span> <span class="p">=</span> <span class="m">300</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">doOnComplete</span> <span class="p">{</span> <span class="n">latch</span><span class="p">.</span><span class="n">countDown</span><span class="p">()</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">subscribe</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">stringBuffer</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$it</span><span class="s2"> &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">latch</span><span class="p">.</span><span class="n">await</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">((</span><span class="nc">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span> <span class="p">-</span> <span class="n">time</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="n">stringBuffer</span><span class="p">.</span><span class="n">toString</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>And for Kotlin Flow:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">private</span> <span class="k">fun</span> <span class="nf">testFlow</span><span class="p">(</span><span class="n">limit</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">10</span><span class="p">,</span> <span class="n">onBackpressure</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;.()</span> <span class="o">-&gt;</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">latch</span> <span class="p">=</span> <span class="n">CountDownLatch</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">time</span> <span class="p">=</span> <span class="nc">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">stringBuffer</span> <span class="p">=</span> <span class="n">StringBuffer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">CoroutineScope</span><span class="p">(</span><span class="n">Job</span><span class="p">()</span> <span class="p">+</span> <span class="nc">Dispatchers</span><span class="p">.</span><span class="n">Default</span><span class="p">).</span><span class="n">launch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">flow</span><span class="p">(</span><span class="n">timeout</span> <span class="p">=</span> <span class="m">100</span><span class="p">,</span> <span class="n">limit</span> <span class="p">=</span> <span class="n">limit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">flowOn</span><span class="p">(</span><span class="nc">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">onBackpressure</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">doWorkDelay</span><span class="p">(</span><span class="n">i</span> <span class="p">=</span> <span class="k">it</span><span class="p">,</span> <span class="n">timeout</span> <span class="p">=</span> <span class="m">200</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">flatMapMerge</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">flowOf</span><span class="p">(</span><span class="k">it</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">doWorkDelay</span><span class="p">(</span><span class="n">i</span> <span class="p">=</span> <span class="k">it</span><span class="p">,</span> <span class="n">timeout</span> <span class="p">=</span> <span class="m">300</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">onCompletion</span> <span class="p">{</span> <span class="n">latch</span><span class="p">.</span><span class="n">countDown</span><span class="p">()</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">collect</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">stringBuffer</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">$it</span><span class="s2"> &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">latch</span><span class="p">.</span><span class="n">await</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">((</span><span class="nc">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span> <span class="p">-</span> <span class="n">time</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">println</span><span class="p">(</span><span class="n">stringBuffer</span><span class="p">.</span><span class="n">toString</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Our expectation is that nothing should be changed, as we’ve just made flatMap over statically done map.
But the results will be the following. For RxJava:</p>
<pre tabindex="0"><code>// LATEST
1734
1 6 10
// BUFFER
5114
1 2 3 4 5 6 7 8 9 10 
// DROP
1106
1 6
</code></pre><p>And for Kotlin Flow:</p>
<pre tabindex="0"><code>// LATEST
1785
1 3 5 7 9 10
// BUFFER 
2426
1 2 3 4 5 6 7 8 9 10 
// DROP
1429
1 3 5 7 9
</code></pre><p>We see that result for RxJava is still the same and for Kotlin Flow it is now different.
The reason about that is that each RxJava operator supports backpressure (because each operator creates new Flowable) when in case of Kotlin Flow you can add backpressure only between two operators.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Though both RxJava Flowable and Kotlin Flow support backpressure there are still differences. Mostly these differences are based on the thing that RxJava has built-in support for backpressure which works from bottom to top (downstream is able to tell upstream when it needs more values) while Kotlin Flow backpressure is based on the suspension mostly.</p>
<p>While migration from RxJava to Kotlin Flow pay additional attention to the places where you use Flowables and backpressure and test thoroughly to not have some unexpected behavior.</p>
<p>Happy coding.</p>

</main>


<hr/>

<footer>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/about">About</a></li>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    <li class="menu-left"><a href="/apps">Apps</a></li>
    
    
    <li class="menu-right"><a rel="me" href="https://t.me/krossovochkin_newsletter" target="_blank"><i class="fa-brands fa-telegram fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://stackoverflow.com/users/1533933/krossovochkin" target="_blank"><i class="fa-brands fa-stack-overflow fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://linkedin.com/in/vasyadrobushkov" target="_blank"><i class="fa-brands fa-linkedin fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://facebook.com/vasya.drobushkov" target="_blank"><i class="fa-brands fa-facebook fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="/index.xml" target="_blank"><i class="fa-solid fa-rss fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://androiddev.social/@krossovochkin" target="_blank"><i class="fa-brands fa-mastodon fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://github.com/krossovochkin" target="_blank"><i class="fa-brands fa-github fa-l"></i></a></li>
    
  </ul>
</nav>

</footer>


</body>

</html>