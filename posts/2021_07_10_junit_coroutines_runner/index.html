<!DOCTYPE html>
<html lang="en-us">
<head>
  <title>JUnit Coroutines Runner</title>

  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="apple-touch-icon-144-precompressed.png"/>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <script src="https://kit.fontawesome.com/6d5aec2882.js" crossorigin="anonymous"></script>

  <script src="https://cdn.counter.dev/script.js" data-id="2d1779da-dc31-440f-8099-940355d12f4d" data-utcoffset="2"></script>
  
  <link rel="stylesheet" href="/css/style.css" />

  <link rel="me" href="https://androiddev.social/@krossovochkin" />

  
  <meta name="theme-color" content="#1e2327">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="JUnit Coroutines Runner">
  <meta name="twitter:description" content="Writing tests for kotlin code with coroutines requires adding runBlockingTest for each test method. In the article we&#39;ll try to work around that so that we don&#39;t need to write it.">

</head>

<body>


      <script async src="https://www.googletagmanager.com/gtag/js?id=G-YEWQ4T95D5"></script>
      <script>
        var doNotTrack = false;
        if ( true ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-YEWQ4T95D5');
        }
      </script>

<header>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/about">About</a></li>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    <li class="menu-left"><a href="/apps">Apps</a></li>
    
    
    <li class="menu-right"><a rel="me" href="https://t.me/krossovochkin_newsletter" target="_blank"><i class="fa-brands fa-telegram fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://stackoverflow.com/users/1533933/krossovochkin" target="_blank"><i class="fa-brands fa-stack-overflow fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://linkedin.com/in/vasyadrobushkov" target="_blank"><i class="fa-brands fa-linkedin fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://facebook.com/vasya.drobushkov" target="_blank"><i class="fa-brands fa-facebook fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="/index.xml" target="_blank"><i class="fa-solid fa-rss fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://androiddev.social/@krossovochkin" target="_blank"><i class="fa-brands fa-mastodon fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://github.com/krossovochkin" target="_blank"><i class="fa-brands fa-github fa-l"></i></a></li>
    
  </ul>
</nav>

</header>

<br/>


<div class="meta">

  
    <h1><span class="title">JUnit Coroutines Runner</span></h1>
  
  
    <h3>July 10, 2021</h3>
  

</div>

<main>
<h3 id="introduction">Introduction</h3>
<p>Recently while writing tests for kotlin code with coroutines I found one annoying thing: almost all the tests start with <code>runBlockingTest</code>. Typing the same stuff repeatedly is something we can&rsquo;t accept! So, I decided to think about how to improve this.</p>
<blockquote>
<p>Disclaimer. Yes, this is an example of how to spend few hours to optimize some task that requires you 2 seconds to complete each time. Even on a scale of hundreds of usages such optimization most likely won&rsquo;t pay your time back. But it is always fun to do some weird things even if you understand that they are stupid.</p>
</blockquote>
<h3 id="basic-test">Basic test</h3>
<p>Let&rsquo;s get to the very beginning: we have some function that does some important work and that is suspendable. For simplicity, the function will return some constant value after some delay.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">calculate</span><span class="p">():</span> <span class="n">Int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">delay</span><span class="p">(</span><span class="m">100L</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The next step is to cover this function with tests. We&rsquo;ll have two tests: one for positive and one for negative cases. This can be considered simple mutation testing. In general, we don&rsquo;t need <code>testFail</code>, but for this specific case, it might be useful to verify that we get green tests only if everything is fine, and if something is wrong that we get red tests as expected.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MainTest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">testSuccess</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">runBlockingTest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">check</span><span class="p">(</span><span class="n">calculate</span><span class="p">()</span> <span class="o">==</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span><span class="p">(</span><span class="n">expected</span> <span class="p">=</span> <span class="n">IllegalStateException</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">testFail</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">runBlockingTest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">check</span><span class="p">(</span><span class="n">calculate</span><span class="p">()</span> <span class="o">==</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This looks a bit wordy and has one level of nesting - not cool. We can work around that by using the body as an expression. Now it will be much better.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MainTest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">testSuccess</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlockingTest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">check</span><span class="p">(</span><span class="n">calculate</span><span class="p">()</span> <span class="o">==</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span><span class="p">(</span><span class="n">expected</span> <span class="p">=</span> <span class="n">IllegalStateException</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">fun</span> <span class="nf">testFail</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlockingTest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">check</span><span class="p">(</span><span class="n">calculate</span><span class="p">()</span> <span class="o">==</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="custom-junit-rule">Custom JUnit Rule</h3>
<p>Our first attempt will be to create custom JUnit rule that will apply <code>runBlockingTest</code> automatically for each of our test methods. This will be our rule:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CoroutinesTestRule</span> <span class="p">:</span> <span class="n">TestRule</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">override</span> <span class="k">fun</span> <span class="nf">apply</span><span class="p">(</span><span class="n">base</span><span class="p">:</span> <span class="n">Statement</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="n">Description</span><span class="p">):</span> <span class="n">Statement</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">object</span> <span class="err">: </span><span class="nc">Statement</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">override</span> <span class="k">fun</span> <span class="nf">evaluate</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">runBlockingTest</span> <span class="p">{</span> <span class="n">base</span><span class="p">.</span><span class="n">evaluate</span><span class="p">()</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Now we can drop <code>runBlockingTest</code> from the test method. But if we do - we face an error:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">testSuccess</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">check</span><span class="p">(</span><span class="n">calculate</span><span class="p">()</span> <span class="o">==</span> <span class="m">1</span><span class="p">)</span> <span class="c1">// Suspend function &#39;calculate&#39; should be called only from a coroutine or another suspend function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>Yes, to call our function under test we need coroutine scope. Previously it was created by <code>runBlockingTest</code> and now it is missing. What can we do? Look at the second part of the error message: &ldquo;or another suspend function&rdquo;. Let&rsquo;s make our test methods <code>suspend</code> and apply our custom rule:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MainTest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@get</span><span class="p">:</span><span class="n">Rule</span>
</span></span><span class="line"><span class="cl">    <span class="k">val</span> <span class="py">rule</span> <span class="p">=</span> <span class="n">CoroutinesTestRule</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">testSuccess</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">check</span><span class="p">(</span><span class="n">calculate</span><span class="p">()</span> <span class="o">==</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Nice!</p>
<p>But after trying to run tests we face an error:</p>
<pre tabindex="0"><code>Method testSuccess() should be void
java.lang.Exception: Method testSuccess() should be void
  at org.junit.runners.model.FrameworkMethod.validatePublicVoid(FrameworkMethod.java:99)
  at org.junit.runners.model.FrameworkMethod.validatePublicVoidNoArg(FrameworkMethod.java:74)
  at org.junit.runners.ParentRunner.validatePublicVoidNoArgMethods(ParentRunner.java:155)
  at org.junit.runners.BlockJUnit4ClassRunner.validateTestMethods(BlockJUnit4ClassRunner.java:208)
</code></pre><p>But it looks like our test method doesn&rsquo;t have return type declared, so it should be <code>Unit</code> and it is the same as <code>Void</code>?<br>
Actually, no. By the way <code>Unit</code> != <code>Void</code>, but in this case, it doesn&rsquo;t matter much. What happens is that after compiling to Java bytecode test method signature will look like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">public</span> <span class="n">Object</span> <span class="n">calculate</span><span class="p">(</span><span class="n">Continuation</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="n">continuation</span><span class="p">)</span>
</span></span></code></pre></div><p>Because of marking method <code>suspend</code> kotlin compiler adds continuation param and <code>Object</code> return type. That <code>Object</code> is used by an internal implementation to e.g. keep track of the internal state.</p>
<h3 id="diving-looking-for-root-cause">Diving looking for root cause</h3>
<p>Something went wrong: we tried to run tests, but we can&rsquo;t because of some internal validation, and we need to find a way to suppress some validation checks.<br>
Looking at the stack trace we find the place where validation checks happen - <code>FrameworkMethod</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Adds to {@code errors} if this method:
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;ul&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;li&gt;is not public, or
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;li&gt;returns something other than void, or
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;li&gt;is static (given {@code isStatic is false}), or
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;li&gt;is not static (given {@code isStatic is true}).
</span></span></span><span class="line"><span class="cl"><span class="cm"> * &lt;/ul&gt;
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">validatePublicVoid</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">isStatic</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="o">&gt;</span><span class="w"> </span><span class="n">errors</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isStatic</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">isStatic</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">isStatic</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s">&#34;should&#34;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s">&#34;should not&#34;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">errors</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&#34;Method &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;() &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34; be static&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">isPublic</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">errors</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&#34;Method &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;() should be public&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">method</span><span class="p">.</span><span class="na">getReturnType</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Void</span><span class="p">.</span><span class="na">TYPE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">errors</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&#34;Method &#34;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">getName</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&#34;() should be void&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>What we need is to be able to override the behavior of that method. Looking more at that class we can find the <code>validatePublicVoidNoArg</code> method. We immediately notice that we should also suppress the validation check that verifies that the method has no arguments. Yes, in general, the test method doesn&rsquo;t have arguments, but after adding <code>suspend</code> kotlin compiler will add the <code>continuation</code> argument automatically. So, we need to suppress that check as well.</p>
<p>The easiest way to do that is to wrap <code>FrameworkMethod</code> into our class, which we&rsquo;ll call <code>SuspendFrameworkMethod</code>, and override the method with a new implementation:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">internal</span> <span class="k">class</span> <span class="nc">SuspendFrameworkMethod</span><span class="p">(</span><span class="k">val</span> <span class="py">frameworkMethod</span><span class="p">:</span> <span class="n">FrameworkMethod</span><span class="p">)</span> <span class="p">:</span> <span class="n">FrameworkMethod</span><span class="p">(</span><span class="n">frameworkMethod</span><span class="p">.</span><span class="n">method</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">override</span> <span class="k">fun</span> <span class="nf">validatePublicVoidNoArg</span><span class="p">(</span><span class="n">isStatic</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">errors</span><span class="p">:</span> <span class="n">MutableList</span><span class="p">&lt;</span><span class="n">Throwable</span><span class="p">&gt;)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">isStatic</span><span class="p">()</span> <span class="o">!=</span> <span class="n">isStatic</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">val</span> <span class="py">state</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">isStatic</span><span class="p">)</span> <span class="s2">&#34;should&#34;</span> <span class="k">else</span> <span class="s2">&#34;should not&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="n">errors</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Exception</span><span class="p">(</span><span class="s2">&#34;Method &#34;</span> <span class="p">+</span> <span class="n">method</span><span class="p">.</span><span class="n">name</span> <span class="p">+</span> <span class="s2">&#34;() &#34;</span> <span class="p">+</span> <span class="n">state</span> <span class="p">+</span> <span class="s2">&#34; be static&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!is</span><span class="n">Public</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">errors</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">Exception</span><span class="p">(</span><span class="s2">&#34;Method &#34;</span> <span class="p">+</span> <span class="n">method</span><span class="p">.</span><span class="n">name</span> <span class="p">+</span> <span class="s2">&#34;() should be public&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// skip check for void
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// skip check for no arg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>We still keep checks that method is public and not static though, as we want to keep these checks.</p>
<p>After creating a wrapper around <code>FrameworkMethod</code> we should hook it somehow.</p>
<h3 id="custom-junit-runner">Custom JUnit Runner</h3>
<p>It turns out that the place where we should add a wrapper is a test runner. Test runner runs tests. Simple as that.<br>
We write our custom runner called <code>CoroutinesTestRunner</code> overriding some methods, so that wrapper <code>SuspendFrameworkMethod</code> will be used calling our overridden checks:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CoroutinesTestRunner</span><span class="p">(</span><span class="n">klass</span><span class="p">:</span> <span class="n">Class</span><span class="p">&lt;*&gt;)</span> <span class="p">:</span> <span class="n">BlockJUnit4ClassRunner</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getChildren</span><span class="p">():</span> <span class="n">MutableList</span><span class="p">&lt;</span><span class="n">FrameworkMethod</span><span class="p">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">super</span><span class="p">.</span><span class="n">getChildren</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">::</span><span class="n">SuspendFrameworkMethod</span><span class="p">).</span><span class="n">toMutableList</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">override</span> <span class="k">fun</span> <span class="nf">validatePublicVoidNoArgMethods</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="k">annotation</span><span class="p">:</span> <span class="n">Class</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">Annotation</span><span class="p">&gt;,</span>
</span></span><span class="line"><span class="cl">        <span class="n">isStatic</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">errors</span><span class="p">:</span> <span class="n">MutableList</span><span class="p">&lt;</span><span class="n">Throwable</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// skip check no arg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">testClass</span><span class="p">.</span><span class="n">getAnnotatedMethods</span><span class="p">(</span><span class="k">annotation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">SuspendFrameworkMethod</span><span class="p">(</span><span class="k">it</span><span class="p">).</span><span class="n">validatePublicVoidNoArg</span><span class="p">(</span><span class="n">isStatic</span><span class="p">,</span> <span class="n">errors</span><span class="p">)</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Now we need to instruct JUnit to use our custom test runner to run our tests:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@RunWith</span><span class="p">(</span><span class="n">CoroutinesTestRunner</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MainTest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">testSuccess</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">check</span><span class="p">(</span><span class="n">calculate</span><span class="p">()</span> <span class="o">==</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span><span class="p">(</span><span class="n">expected</span> <span class="p">=</span> <span class="n">IllegalStateException</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">testFail</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">check</span><span class="p">(</span><span class="n">calculate</span><span class="p">()</span> <span class="o">==</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>We run tests and again see the issue:</p>
<pre tabindex="0"><code>wrong number of arguments
java.lang.IllegalArgumentException: wrong number of arguments
  at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
  at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
  at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
  at java.base/java.lang.reflect.Method.invoke(Method.java:566)
  at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)
  at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
  at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)
</code></pre><p>Meh, we need to do something with that as well.</p>
<h3 id="reflection">Reflection</h3>
<p>JUnit uses reflection under the hood to run tests. Using reflection JUnit collects all the methods marked with <code>@Test</code> annotation and invokes them proving target and params.
We can see how it is done by looking at the <code>FrameworkMethod#invokeExplosively</code> method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Returns the result of invoking this method on {@code target} with
</span></span></span><span class="line"><span class="cl"><span class="cm"> * parameters {@code params}. {@link InvocationTargetException}s thrown are
</span></span></span><span class="line"><span class="cl"><span class="cm"> * unwrapped, and their causes rethrown.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">invokeExplosively</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Object</span><span class="p">...</span><span class="w"> </span><span class="n">params</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ReflectiveCallable</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nd">@Override</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">protected</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">runReflectiveCall</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">params</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}.</span><span class="na">run</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>We have the wrong number of arguments because we need to provide <code>continuation</code> as a parameter. An attentive reader could spot that we haven&rsquo;t added <code>runBlockingTest</code> yet.<br>
Let&rsquo;s do that in our <code>SuspendFrameworkMethod</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Throws</span><span class="p">(</span><span class="n">Throwable</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">override</span> <span class="k">fun</span> <span class="nf">invokeExplosively</span><span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="n">Any</span><span class="p">?,</span> <span class="k">vararg</span> <span class="n">params</span><span class="p">:</span> <span class="n">Any</span><span class="p">?):</span> <span class="n">Any</span><span class="p">?</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">object</span> <span class="err">: </span><span class="nc">ReflectiveCallable</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nd">@Throws</span><span class="p">(</span><span class="n">Throwable</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">override</span> <span class="k">fun</span> <span class="nf">runReflectiveCall</span><span class="p">():</span> <span class="n">Any</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">runBlockingTest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">suspendCoroutine</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">continuation</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">frameworkMethod</span><span class="p">.</span><span class="n">invokeExplosively</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">continuation</span><span class="p">,</span> <span class="p">*</span><span class="n">params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}.</span><span class="n">run</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>We wrap the <code>invokeExplosively</code> method with <code>runBlockingTest</code> and create a separate <code>suspendCoroutine</code> to access continuation.</p>
<p>We then run our tests and they are green!<br>
Awesome!</p>
<h3 id="result">Result</h3>
<p>Now, with <code>CoroutineTestRunner</code> we can write our tests like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@RunWith</span><span class="p">(</span><span class="n">CoroutinesTestRunner</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">MainTest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span>
</span></span><span class="line"><span class="cl">    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">testSuccess</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">check</span><span class="p">(</span><span class="n">calculate</span><span class="p">()</span> <span class="o">==</span> <span class="m">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@Test</span><span class="p">(</span><span class="n">expected</span> <span class="p">=</span> <span class="n">IllegalStateException</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">suspend</span> <span class="k">fun</span> <span class="nf">testFail</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">check</span><span class="p">(</span><span class="n">calculate</span><span class="p">()</span> <span class="o">==</span> <span class="m">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>No more explicit <code>runBlockingTest</code>!</p>
<p>Is it good to use this approach though?</p>
<p>NO.</p>
<p>Please, don&rsquo;t try to do anything like this in a real project. The current implementation has many disadvantages:</p>
<ul>
<li>We got rid of <code>runBlockingTest</code> but now we should add to each test <code>suspend</code>. That is a very little gain in characters to be saved</li>
<li><code>runBlockingTest</code> not only provides the scope - it provides a test scope that has additional test methods like <code>advanceTimeBy</code>. And we don&rsquo;t have that test scope anymore. Trying to pass it to the method requires additional changes in our <code>SuspendFrameworkMethod</code> and the resulting test methods will look like this:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">suspend</span> <span class="k">fun</span> <span class="nf">test</span><span class="p">(</span><span class="n">scope</span><span class="p">:</span> <span class="n">TestCorotinesScope</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>This is even more verbose than using <code>runBlockingTest</code>.</p>
<p>So, after all, have to admit that this &ldquo;optimization&rdquo; actually doesn&rsquo;t make the test methods look better. Still, the preferred way to write tests is:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-kotlin" data-lang="kotlin"><span class="line"><span class="cl"><span class="nd">@Test</span>
</span></span><span class="line"><span class="cl"><span class="k">fun</span> <span class="nf">test</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlockingTest</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><p>But at least we had some fun and probably understand better the internals of the JUnit framework.</p>
<p>Happy coding!</p>

</main>


<hr/>

<footer>
<nav>
  <ul>
    
    <li class="menu-left"><a href="/about">About</a></li>
    
    <li class="menu-left"><a href="/">Posts</a></li>
    
    <li class="menu-left"><a href="/apps">Apps</a></li>
    
    
    <li class="menu-right"><a rel="me" href="https://t.me/krossovochkin_newsletter" target="_blank"><i class="fa-brands fa-telegram fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://stackoverflow.com/users/1533933/krossovochkin" target="_blank"><i class="fa-brands fa-stack-overflow fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://linkedin.com/in/vasyadrobushkov" target="_blank"><i class="fa-brands fa-linkedin fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://facebook.com/vasya.drobushkov" target="_blank"><i class="fa-brands fa-facebook fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="/index.xml" target="_blank"><i class="fa-solid fa-rss fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://androiddev.social/@krossovochkin" target="_blank"><i class="fa-brands fa-mastodon fa-l"></i></a></li>
    
    <li class="menu-right"><a rel="me" href="https://github.com/krossovochkin" target="_blank"><i class="fa-brands fa-github fa-l"></i></a></li>
    
  </ul>
</nav>

</footer>


</body>

</html>